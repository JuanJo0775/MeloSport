{% extends "backoffice/base_backoffice.html" %}
{% load breadcrumbs %}

{% block title %}Cambiar Contraseña - {{ object.get_full_name|default:object.username }}{% endblock %}

{% block breadcrumb %}
  <nav aria-label="breadcrumb" class="breadcrumb-wrapper">
    <ol class="breadcrumb small mb-2">
      {% breadcrumb "Usuarios|backoffice:users:list" "Cambiar contraseña" %}
    </ol>
  </nav>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-8">
      <!-- Header de la página -->
      <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
          <h2 class="h4 mb-1">
            <i class="bi bi-key text-primary me-2"></i>
            Cambiar Contraseña
          </h2>
          <p class="text-muted mb-0">
            Definir nueva contraseña para <strong>{{ object.get_full_name|default:object.username }}</strong>
          </p>
        </div>
        <div>
          <a href="{% url 'backoffice:users:list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>
            Volver
          </a>
        </div>
      </div>

      <!-- Información del usuario -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-auto">
              <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center"
                   style="width: 60px; height: 60px;">
                <i class="bi bi-person-fill text-primary fs-4"></i>
              </div>
            </div>
            <div class="col">
              <h5 class="mb-1">{{ object.get_full_name|default:object.username }}</h5>
              <p class="text-muted mb-1">
                <i class="bi bi-envelope me-1"></i>
                {{ object.email|default:"Sin email" }}
              </p>
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <span class="badge {% if object.is_active %}bg-success{% else %}bg-danger{% endif %}">
                  {% if object.is_active %}
                    <i class="bi bi-check-circle me-1"></i>Activo
                  {% else %}
                    <i class="bi bi-x-circle me-1"></i>Inactivo
                  {% endif %}
                </span>
                {% if object.groups.exists %}
                  {% for group in object.groups.all %}
                    <span class="badge {% if group.name|lower == 'admin' %}bg-danger{% else %}bg-secondary{% endif %}">
                      <i class="bi bi-shield-check me-1"></i>{{ group.name }}
                    </span>
                  {% endfor %}
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Formulario de cambio de contraseña -->
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="card-title mb-0">
            <i class="bi bi-lock me-2"></i>
            Cambiar Contraseña
          </h5>
        </div>
        <div class="card-body">
          <form method="post" novalidate>
            {% csrf_token %}

            <!-- Mensajes de error general -->
            {% if form.non_field_errors %}
              <div class="alert alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>
                {% for error in form.non_field_errors %}
                  {{ error }}
                {% endfor %}
              </div>
            {% endif %}

            <div class="row">
              <div class="col-12 col-md-8">

                <!-- Contraseña actual -->
                <div class="mb-3">
                  <label for="{{ form.old_password.id_for_label }}" class="form-label fw-medium">
                    <i class="bi bi-lock-fill me-1"></i>
                    Contraseña Actual <span class="text-danger">*</span>
                  </label>
                  <div class="position-relative">
                    {{ form.old_password }}
                    <button type="button" class="btn btn-outline-secondary position-absolute"
                            style="right: 0; top: 0; height: 100%; border-left: 0;"
                            onclick="togglePassword('{{ form.old_password.id_for_label }}', this)">
                      <i class="bi bi-eye"></i>
                    </button>
                  </div>
                  {% if form.old_password.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.old_password.errors %}
                        <small><i class="bi bi-exclamation-circle me-1"></i>{{ error }}</small><br>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                <!-- Nueva contraseña -->
                <div class="mb-3">
                  <label for="{{ form.new_password1.id_for_label }}" class="form-label fw-medium">
                    <i class="bi bi-key me-1"></i>
                    Nueva Contraseña <span class="text-danger">*</span>
                  </label>
                  <div class="position-relative">
                    {{ form.new_password1 }}
                    <button type="button" class="btn btn-outline-secondary position-absolute"
                            style="right: 0; top: 0; height: 100%; border-left: 0;"
                            onclick="togglePassword('{{ form.new_password1.id_for_label }}', this)">
                      <i class="bi bi-eye"></i>
                    </button>
                  </div>
                  {% if form.new_password1.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.new_password1.errors %}
                        <small><i class="bi bi-exclamation-circle me-1"></i>{{ error }}</small><br>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                <!-- Confirmar contraseña -->
                <div class="mb-4">
                  <label for="{{ form.new_password2.id_for_label }}" class="form-label fw-medium">
                    <i class="bi bi-shield-check me-1"></i>
                    Confirmar Nueva Contraseña <span class="text-danger">*</span>
                  </label>
                  <div class="position-relative">
                    {{ form.new_password2 }}
                    <button type="button" class="btn btn-outline-secondary position-absolute"
                            style="right: 0; top: 0; height: 100%; border-left: 0;"
                            onclick="togglePassword('{{ form.new_password2.id_for_label }}', this)">
                      <i class="bi bi-eye"></i>
                    </button>
                  </div>
                  {% if form.new_password2.errors %}
                    <div class="invalid-feedback d-block">
                      {% for error in form.new_password2.errors %}
                        <small><i class="bi bi-exclamation-circle me-1"></i>{{ error }}</small><br>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                <!-- Botones -->
                <div class="d-flex gap-2 justify-content-end">
                  <a href="{% url 'backoffice:users:list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-lg me-1"></i>
                    Cancelar
                  </a>
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-lg me-1"></i>
                    Actualizar Contraseña
                  </button>
                </div>
              </div>

              <!-- Panel de seguridad -->
              <div class="col-12 col-md-4">
                <div class="bg-light rounded p-3 h-100">
                  <h6 class="text-primary mb-3">
                    <i class="bi bi-shield-lock me-2"></i>
                    Políticas de Seguridad
                  </h6>
                  <ul class="list-unstyled small">
                    <li><i class="bi bi-check2 text-success me-2"></i>Mínimo 8 caracteres</li>
                    <li><i class="bi bi-check2 text-success me-2"></i>Combinar letras y números</li>
                    <li><i class="bi bi-check2 text-success me-2"></i>Evitar contraseñas comunes</li>
                    <li><i class="bi bi-check2 text-success me-2"></i>No similar al usuario</li>
                  </ul>
                  <hr class="my-3">
                  <div class="text-warning small">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Importante:</strong> La contraseña actual será reemplazada inmediatamente.
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function togglePassword(fieldId, button) {
  const field = document.getElementById(fieldId);
  const icon = button.querySelector('i');
  if (field.type === 'password') {
    field.type = 'text';
    icon.classList.replace('bi-eye', 'bi-eye-slash');
  } else {
    field.type = 'password';
    icon.classList.replace('bi-eye-slash', 'bi-eye');
  }
}
</script>
{% endblock %}

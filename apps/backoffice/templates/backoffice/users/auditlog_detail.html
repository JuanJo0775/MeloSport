{% extends "backoffice/base_backoffice.html" %}
{% load breadcrumbs %}

{% block title %}Detalle de Auditoría{% endblock %}

{% block breadcrumb %}
  {% breadcrumb "Gestión|backoffice:users:list" "Usuarios|backoffice:users:list" "Auditoría|backoffice:users:audit_list" "Detalle" %}
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <h3 class="mb-0">
          <i class="bi bi-file-text stats-icon me-2"></i>
          Detalle del Registro de Auditoría
        </h3>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="window.print()">
            <i class="bi bi-printer me-1"></i> Imprimir
          </button>
          <a href="{% url 'backoffice:users:audit_list' %}" class="btn btn-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i> Volver a Auditoría
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Información principal -->
    <div class="col-lg-8">
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h6 class="mb-0">
            <i class="bi bi-info-circle me-2"></i>
            Información del Registro
          </h6>
        </div>
        <div class="card-body">
          <dl class="row">
            <dt class="col-sm-3 mb-3">
              <i class="bi bi-person me-2 text-muted"></i>
              Usuario
            </dt>
            <dd class="col-sm-9 mb-3">
              <div class="d-flex align-items-center">
                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3"
                     style="width: 40px; height: 40px;">
                  <i class="bi bi-person text-white"></i>
                </div>
                <div>
                  <div class="fw-medium">{{ log.user.get_full_name|default:log.user.username|default:"Sistema" }}</div>
                  {% if log.user %}
                  <small class="text-muted">@{{ log.user.username }} (ID: {{ log.user.id }})</small>
                  {% else %}
                  <small class="text-muted">Acción del sistema</small>
                  {% endif %}
                </div>
              </div>
            </dd>

            <dt class="col-sm-3 mb-3">
              <i class="bi bi-activity me-2 text-muted"></i>
              Acción
            </dt>
            <dd class="col-sm-9 mb-3">
              <span class="badge fs-6
                {% if log.action == 'CREATE' %}badge-success
                {% elif log.action == 'UPDATE' %}badge-warning
                {% elif log.action == 'DELETE' %}badge-danger
                {% else %}bg-secondary{% endif %}">
                {% if log.action == 'CREATE' %}
                  <i class="bi bi-plus-circle me-2"></i> CREACIÓN
                {% elif log.action == 'UPDATE' %}
                  <i class="bi bi-pencil me-2"></i> ACTUALIZACIÓN
                {% elif log.action == 'DELETE' %}
                  <i class="bi bi-trash me-2"></i> ELIMINACIÓN
                {% else %}
                  <i class="bi bi-gear me-2"></i> {{ log.action }}
                {% endif %}
              </span>
            </dd>

            <dt class="col-sm-3 mb-3">
              <i class="bi bi-database me-2 text-muted"></i>
              Modelo
            </dt>
            <dd class="col-sm-9 mb-3">
              <span class="bg-light px-3 py-2 rounded">
                <i class="bi bi-box me-2"></i>
                {{ log.model }}
              </span>
            </dd>

            <dt class="col-sm-3 mb-3">
              <i class="bi bi-hash me-2 text-muted"></i>
              Objeto ID
            </dt>
            <dd class="col-sm-9 mb-3">
              <code class="bg-light px-2 py-1 rounded">{{ log.object_id|default:"-" }}</code>
            </dd>

            <dt class="col-sm-3 mb-3">
              <i class="bi bi-globe me-2 text-muted"></i>
              Dirección IP
            </dt>
            <dd class="col-sm-9 mb-3">
              <code class="bg-light px-2 py-1 rounded">{{ log.ip_address|default:"No disponible" }}</code>
            </dd>

            <dt class="col-sm-3 mb-0">
              <i class="bi bi-calendar3 me-2 text-muted"></i>
              Fecha y Hora
            </dt>
            <dd class="col-sm-9 mb-0">
              <div>
                <strong>{{ log.created_at|date:"d/m/Y" }}</strong> a las
                <strong>{{ log.created_at|date:"H:i:s" }}</strong>
              </div>
              <small class="text-muted">{{ log.created_at|timesince }} atrás</small>
            </dd>
          </dl>
        </div>
      </div>

      <!-- Datos del registro -->
      {% if log.data %}
      <div class="card">
        <div class="card-header bg-white">
          <h6 class="mb-0">
            <i class="bi bi-code me-2"></i>
            Datos del Registro
          </h6>
        </div>
        <div class="card-body">
          <div class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">
            <pre class="mb-0"><code>{{ log.get_data_display }}</code></pre>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Panel lateral con información adicional -->
    <div class="col-lg-4">
      <!-- Resumen del registro -->
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h6 class="mb-0">
            <i class="bi bi-clipboard-check me-2"></i>
            Resumen
          </h6>
        </div>
        <div class="card-body">
          <div class="text-center mb-3">
            <div class="stats-icon mb-2
              {% if log.action == 'CREATE' %}text-success
              {% elif log.action == 'UPDATE' %}text-warning
              {% elif log.action == 'DELETE' %}text-danger
              {% else %}text-secondary{% endif %}">
              {% if log.action == 'CREATE' %}
                <i class="bi bi-plus-circle-fill"></i>
              {% elif log.action == 'UPDATE' %}
                <i class="bi bi-pencil-fill"></i>
              {% elif log.action == 'DELETE' %}
                <i class="bi bi-trash-fill"></i>
              {% else %}
                <i class="bi bi-gear-fill"></i>
              {% endif %}
            </div>
            <h6 class="fw-bold">Registro #{{ log.id }}</h6>
            <p class="text-muted small mb-0">
              {% if log.action == 'CREATE' %}
                Se creó un nuevo registro
              {% elif log.action == 'UPDATE' %}
                Se actualizó un registro existente
              {% elif log.action == 'DELETE' %}
                Se eliminó un registro
              {% else %}
                Acción personalizada realizada
              {% endif %}
            </p>
          </div>

          <hr>

          <div class="row g-2 text-center">
            <div class="col-6">
              <div class="border rounded p-2">
                <div class="fw-bold text-primary">{{ log.model }}</div>
                <small class="text-muted">Modelo</small>
              </div>
            </div>
            <div class="col-6">
              <div class="border rounded p-2">
                <div class="fw-bold text-primary">{{ log.object_id|default:"N/A" }}</div>
                <small class="text-muted">ID Objeto</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Información del usuario (si existe) -->
      {% if log.user %}
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h6 class="mb-0">
            <i class="bi bi-person-badge me-2"></i>
            Usuario Responsable
          </h6>
        </div>
        <div class="card-body">
          <div class="text-center mb-3">
            <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-2"
                 style="width: 50px; height: 50px;">
              <i class="bi bi-person text-white fs-4"></i>
            </div>
            <h6 class="fw-bold mb-1">{{ log.user.get_full_name|default:log.user.username }}</h6>
            <p class="text-muted small mb-0">@{{ log.user.username }}</p>
          </div>

          <div class="small">
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Email:</span>
              <span>{{ log.user.email|default:"-" }}</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Estado:</span>
              <span class="badge {% if log.user.is_active %}badge-success{% else %}badge-danger{% endif %}">
                {% if log.user.is_active %}Activo{% else %}Inactivo{% endif %}
              </span>
            </div>
            <div class="d-flex justify-content-between mb-0">
              <span class="text-muted">Grupos:</span>
              <span>
                {% for group in log.user.groups.all %}
                  <span class="badge bg-secondary me-1">{{ group.name }}</span>
                {% empty %}
                  <span class="text-muted">-</span>
                {% endfor %}
              </span>
            </div>
          </div>

          <hr>

          <div class="d-grid">
            <a href="{% url 'backoffice:users:detail' log.user.pk %}" class="btn btn-outline-primary btn-sm">
              <i class="bi bi-eye me-1"></i> Ver Usuario
            </a>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Información técnica -->
      <div class="card">
        <div class="card-header bg-white">
          <h6 class="mb-0">
            <i class="bi bi-gear me-2"></i>
            Información Técnica
          </h6>
        </div>
        <div class="card-body small">
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">ID del Registro:</span>
            <code>{{ log.id }}</code>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Timestamp:</span>
            <code>{{ log.created_at|date:"c" }}</code>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Zona Horaria:</span>
            <code>{{ log.created_at|date:"T" }}</code>
          </div>
          {% if log.data %}
          <div class="d-flex justify-content-between mb-0">
            <span class="text-muted">Tiene Datos:</span>
            <span class="badge badge-success">Sí</span>
          </div>
          {% else %}
          <div class="d-flex justify-content-between mb-0">
            <span class="text-muted">Tiene Datos:</span>
            <span class="badge bg-secondary">No</span>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
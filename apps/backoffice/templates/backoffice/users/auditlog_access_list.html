{% extends "backoffice/base_backoffice.html" %}
{% load breadcrumbs %}

{% block title %}Accesos de Usuarios{% endblock %}

{% block breadcrumb %}
  {% breadcrumb "Auditoría|backoffice:users:auditlog_list" "Accesos" %}
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
      <h3 class="mb-0">
        <i class="bi bi-bezier2 me-2"></i> Registros de Acceso / Navegación
      </h3>
      <div class="d-flex gap-2">
        <!-- Botón imprimir -->
        <button id="btn-print" type="button" class="btn btn-outline-primary btn-sm" onclick="printOnlyTable()">
          <i class="bi bi-printer me-1"></i> Imprimir
        </button>
        <!-- Volver -->
        <a href="{% url 'backoffice:users:auditlog_list' %}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-1"></i>
          Auditoría general
        </a>
      </div>
    </div>
  </div>

  <!-- Estadísticas rápidas -->
<div class="row mb-4">
  <!-- Total accesos -->
  <div class="col-md-4">
    <div class="card stats-card border-left-primary">
      <div class="card-body d-flex align-items-center">
        <div class="stats-icon me-3 text-primary">
          <i class="bi bi-activity"></i>
        </div>
        <div>
          <div class="text-muted small">Total Accesos</div>
          <div class="fw-bold h5 mb-0">{{ total_access }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Usuarios únicos -->
  <div class="col-md-4">
    <div class="card stats-card border-left-success">
      <div class="card-body d-flex align-items-center">
        <div class="stats-icon me-3 text-success">
          <i class="bi bi-people"></i>
        </div>
        <div>
          <div class="text-muted small">Usuarios Únicos</div>
          <div class="fw-bold h5 mb-0">{{ unique_users }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Periodo -->
  <div class="col-md-4">
    <div class="card stats-card border-left-warning">
      <div class="card-body d-flex align-items-center">
        <div class="stats-icon me-3 text-warning">
          <i class="bi bi-calendar-event"></i>
        </div>
        <div>
          <div class="text-muted small">Periodo</div>
          <div class="fw-bold h6 mb-0">
            {% if request.GET.period == "day" %}Hoy
            {% elif request.GET.period == "week" %}Esta Semana
            {% elif request.GET.period == "month" %}Este Mes
            {% elif request.GET.period == "year" %}Este Año
            {% else %}Todos{% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


{% if retention_days %}
  <div class="alert alert-info d-flex align-items-center mt-2" role="alert"
       style="font-size: 0.9rem; border-left: 4px solid #0dcaf0;">
    <i class="bi bi-clock-history me-2"></i>
    <div>
      Los registros de acceso se eliminan automáticamente después de
      <strong>{{ retention_days }} días</strong>.
    </div>
  </div>
{% endif %}

<!-- Filtros -->
<div class="card mb-4">
  <div class="card-header bg-white d-flex justify-content-between align-items-center flex-wrap" style="gap: 10px;">
    <h6 class="mb-0">
      <i class="bi bi-funnel me-2"></i>Filtros de Búsqueda
    </h6>

    <div class="d-flex flex-wrap align-items-center gap-2" style="min-width: 280px; justify-content: flex-end;">
      <!-- Limpieza automática -->
      <div class="btn-group">
        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <i class="bi bi-calendar-x me-1"></i> Limpieza automática
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li>
            <a class="dropdown-item" href="?retention=7">
              <i class="bi bi-calendar3-week me-1 text-primary"></i> Mantener últimos 7 días
            </a>
          </li>
          <li>
            <a class="dropdown-item" href="?retention=15">
              <i class="bi bi-calendar2-week me-1 text-warning"></i> Mantener últimos 15 días
            </a>
          </li>
          <li>
            <a class="dropdown-item" href="?retention=30">
              <i class="bi bi-calendar3 me-1 text-success"></i> Mantener últimos 30 días
            </a>
          </li>
        </ul>
      </div>

      <!-- Eliminar todos -->
      <a href="{% url 'backoffice:users:auditlog_access_delete_all' %}"
         class="btn btn-sm btn-danger"
         style="white-space: nowrap;">
        <i class="bi bi-trash me-1"></i> Eliminar todos
      </a>
    </div>
  </div>

  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-4">
        <label for="q" class="form-label small">Buscar Usuario / Ruta</label>
        <input type="text" name="q" id="q" class="form-control form-control-sm"
               placeholder="Nombre, email, ruta" value="{{ request.GET.q }}">
      </div>

      <div class="col-md-2">
        <label for="period" class="form-label small">Periodo</label>
        <select name="period" id="period" class="form-select form-select-sm">
          <option value="">-- Todos --</option>
          <option value="day" {% if request.GET.period == "day" %}selected{% endif %}>Hoy</option>
          <option value="week" {% if request.GET.period == "week" %}selected{% endif %}>Semana</option>
          <option value="month" {% if request.GET.period == "month" %}selected{% endif %}>Mes</option>
          <option value="year" {% if request.GET.period == "year" %}selected{% endif %}>Año</option>
        </select>
      </div>

      <div class="col-md-2">
        <label for="date" class="form-label small">Fecha específica</label>
        <input type="date" name="date" id="date" class="form-control form-control-sm" value="{{ request.GET.date }}">
      </div>

      <!-- Botones de filtrar/limpiar -->
      <div class="col-md-2 d-flex align-items-end flex-wrap gap-2">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-funnel me-1"></i> Filtrar
        </button>
        <a href="{% url 'backoffice:users:auditlog_access_list' %}" class="btn btn-outline-secondary" title="Restablecer">
          <i class="bi bi-arrow-clockwise"></i> Limpiar
        </a>
      </div>
    </form>
  </div>
</div>


  <!-- Tabla (print-area) -->
  <div class="card print-area">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
      <h6 class="mb-0"><i class="bi bi-table me-2"></i>Accesos</h6>
      <small class="text-muted">Mostrando {{ page_obj.paginator.count }} accesos</small>
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th><i class="bi bi-calendar3 me-1"></i> Fecha</th>
              <th><i class="bi bi-person me-1"></i> Usuario</th>
              <th><i class="bi bi-link-45deg me-1"></i> Página / Ruta</th>
              <th><i class="bi bi-hash me-1"></i> Método</th>
              <th><i class="bi bi-globe me-1"></i> IP</th>
              <th class="text-center"><i class="bi bi-eye me-1"></i> Detalle</th>
            </tr>
          </thead>
          <tbody>
            {% for log in logs %}
            <tr>
              <td>
                <div class="fw-medium">{{ log.created_at|date:"d/m/Y" }}</div>
                <small class="text-muted">{{ log.created_at|date:"H:i:s" }}</small>
              </td>
              <td>
                {% if log.user %}
                  <div class="fw-medium">{{ log.user.get_full_name|default:log.user.username }}</div>
                  <small class="text-muted">@{{ log.user.username }}</small>
                {% else %}
                  <span class="text-muted">Sistema</span>
                {% endif %}
              </td>
              <td class="text-truncate" style="max-width: 300px;" title="{{ log.description }}">
                {% if "POST" in log.description %}
                  <span class="badge bg-success text-white">{{ log.description }}</span>
                {% elif "GET" in log.description %}
                  <span class="badge bg-primary text-white">{{ log.description }}</span>
                {% elif "DELETE" in log.description %}
                  <span class="badge bg-danger text-white">{{ log.description }}</span>
                {% elif "PUT" in log.description or "UPDATE" in log.description %}
                  <span class="badge bg-warning text-dark">{{ log.description }}</span>
                {% else %}
                  <span class="badge bg-secondary text-white">{{ log.description }}</span>
                {% endif %}
              </td>
              <td><code>{{ log.data.extra.method|default:"-" }}</code></td>
              <td><code class="text-muted">{{ log.ip_address|default:"-" }}</code></td>
              <td class="text-center">
                <a href="{% url 'backoffice:users:audit_access_detail' log.pk %}"
                   class="btn btn-sm btn-outline-primary" title="Ver detalle">
                  <i class="bi bi-eye"></i>
                </a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center py-4 text-muted">
                <i class="bi bi-inbox mb-2"></i><br>No hay accesos que coincidan con los filtros
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    {% if is_paginated %}
    <div class="card-footer bg-white">
      <nav aria-label="Paginación">
        <ul class="pagination justify-content-center mb-0">
          {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link"
               href="?page={{ page_obj.previous_page_number }}&q={{ request.GET.q|urlencode }}&period={{ request.GET.period }}&date={{ request.GET.date }}">
              <i class="bi bi-chevron-left"></i> Anterior
            </a>
          </li>
          {% endif %}
          <li class="page-item disabled">
            <span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
          </li>
          {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link"
               href="?page={{ page_obj.next_page_number }}&q={{ request.GET.q|urlencode }}&period={{ request.GET.period }}&date={{ request.GET.date }}">
              Siguiente <i class="bi bi-chevron-right"></i>
            </a>
          </li>
          {% endif %}
        </ul>
      </nav>
    </div>
    {% endif %}
  </div>
</div>

<script>
function printOnlyTable() {
  var el = document.querySelector('.print-area');
  if (!el) { window.print(); return; }
  var newWin = window.open('', '_blank', 'noopener,noreferrer');
  if (!newWin) { document.body.classList.add('print-mode'); window.print(); setTimeout(()=>{document.body.classList.remove('print-mode');},800); return; }
  var css = '';
  document.querySelectorAll('link[rel="stylesheet"]').forEach(link=>{ css += link.outerHTML; });
  document.querySelectorAll('style').forEach(s=>{ css += s.outerHTML; });
  var html = '<!doctype html><html><head><meta charset="utf-8"><title>Imprimir - Accesos</title>'+css+'</head><body>'+el.outerHTML+'</body></html>';
  newWin.document.open(); newWin.document.write(html); newWin.document.close();
  newWin.focus(); newWin.addEventListener('load', ()=>{ try{ newWin.print(); newWin.close(); }catch(e){} });
  setTimeout(()=>{ try{ newWin.print(); newWin.close(); }catch(e){ document.body.classList.add('print-mode'); window.print(); setTimeout(()=>{document.body.classList.remove('print-mode');},800);} }, 1000);
}
</script>

{% endblock %}

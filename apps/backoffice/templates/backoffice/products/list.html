{% extends "backoffice/base_backoffice.html" %}
{% load breadcrumbs %}
{% load static %}
{% load money %}

{% block title %}Productos - Melosport{% endblock %}

{% block breadcrumb %}
  {% breadcrumb "Productos|backoffice:products:product_list" %}
{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- Título y botón -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h4">Listado de Productos</h2>
    {% if perms.products.add_product %}
      <a href="{% url 'backoffice:products:product_create' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Nuevo Producto
      </a>
    {% endif %}
  </div>

  <!-- Estadísticas rápidas -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card border-0 bg-success bg-opacity-10 stats-card">
        <div class="card-body text-center">
          <h4 class="text-success mb-1">{{ productos_activos|default:"0" }}</h4>
          <p class="text-muted mb-0">Productos Activos</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-0 bg-secondary bg-opacity-10 stats-card">
        <div class="card-body text-center">
          <h4 class="text-secondary mb-1">{{ productos_inactivos|default:"0" }}</h4>
          <p class="text-muted mb-0">Productos Inactivos</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-0 bg-primary bg-opacity-10 stats-card">
        <div class="card-body text-center">
          <h4 class="text-primary mb-1">{{ variantes_count|default:"0" }}</h4>
          <p class="text-muted mb-0">Variantes Totales</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-0 bg-info bg-opacity-10 stats-card">
        <div class="card-body text-center">
          <h4 class="text-info mb-1">{{ imagenes_count|default:"0" }}</h4>
          <p class="text-muted mb-0">Imágenes Asociadas</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulario de filtros -->
  <div class="card shadow-sm mb-4">
    <div class="card-header">
      <h6 class="mb-0"><i class="bi bi-funnel"></i> Filtros de Búsqueda</h6>
    </div>
    <div class="card-body">
      <form method="get" class="row g-2">
        <div class="col-md-3">
          <label class="form-label">Buscar</label>
          <input type="text" name="q" value="{{ request.GET.q }}" class="form-control" placeholder="Nombre o SKU...">
        </div>

        <div class="col-md-2">
          <label class="form-label">Precio mínimo</label>
          <input type="number" step="0.01" name="price_min" value="{{ request.GET.price_min }}" class="form-control" placeholder="0.00">
        </div>

        <div class="col-md-2">
          <label class="form-label">Precio máximo</label>
          <input type="number" step="0.01" name="price_max" value="{{ request.GET.price_max }}" class="form-control" placeholder="999.99">
        </div>

        <div class="col-md-2">
          <label class="form-label">Variantes</label>
          <select name="has_variants" class="form-select">
            <option value="">Todos</option>
            <option value="true" {% if request.GET.has_variants == "true" %}selected{% endif %}>Con variantes</option>
            <option value="false" {% if request.GET.has_variants == "false" %}selected{% endif %}>Sin variantes</option>
          </select>
        </div>

        <div class="col-md-1">
          <label class="form-label">Estado</label>
          <select name="status" class="form-select">
            <option value="">Todos</option>
            <option value="active" {% if request.GET.status == "active" %}selected{% endif %}>Activo</option>
            <option value="inactive" {% if request.GET.status == "inactive" %}selected{% endif %}>Inactivo</option>
          </select>
        </div>

        <!-- Botones: Buscar + Limpiar -->
<div class="col-md-2 d-grid">
  <label class="form-label">&nbsp;</label>
  <div class="d-flex gap-2 align-items-center">

    <!-- Botón aplicar filtros (ocupa todo el ancho) -->
    <button type="submit"
            class="btn btn-primary d-flex align-items-center justify-content-center gap-2 w-100"
            title="Aplicar filtros">
      <i class="bi bi-funnel"></i>
      Filtrar
    </button>

    <!-- Botón limpiar filtros (rectangular con icono en círculo) -->
    <a href="{% url 'backoffice:products:product_list' %}"
       class="btn btn-outline-secondary d-flex align-items-center justify-content-center px-3"
       title="Limpiar filtros">
      <span class="d-inline-flex align-items-center justify-content-center rounded-circle border"
            style="width: 20px; height: 20px;">
        <i class="bi bi-x"></i>
      </span>
    </a>

  </div>
</div>
      </form>
    </div>
  </div>

  <!-- Tabla de productos -->
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h6 class="mb-0"><i class="bi bi-grid-3x3-gap"></i> Productos ({{ products|length }})</h6>
      <small class="text-muted">Total registros: {{ products.paginator.count|default:products|length }}</small>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>SKU</th>
              <th>Nombre</th>
              <th class="text-end">Precio</th>
              <th class="text-center">Stock</th>
              <th class="text-center">Variantes</th>
              <th class="text-center">Estado</th>
              <th class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for product in products %}
            <tr>
              <td>
                <code class="text-mono">{{ product.sku }}</code>
              </td>
              <td>
                <div class="d-flex align-items-center">
                  <div class="me-2">
                    {% if product.get_main_image %}
                      <img src="{{ product.get_main_image.url }}" alt="{{ product.name }}"
                           class="gallery-thumb" style="width: 40px; height: 40px;">
                    {% else %}
                      <div class="bg-light rounded d-flex align-items-center justify-content-center"
                           style="width: 40px; height: 40px;">
                        <i class="bi bi-image text-muted"></i>
                      </div>
                    {% endif %}
                  </div>
                  <div>
                    {% if perms.products.view_product %}
                      <a href="{% url 'backoffice:products:product_detail' product.pk %}" class="text-decoration-none">
                        <strong>{{ product.name }}</strong>
                      </a>
                    {% else %}
                      <strong>{{ product.name }}</strong>
                    {% endif %}
                    {% if product.description %}
                      <br><small class="text-muted">{{ product.description|truncatechars:50 }}</small>
                    {% endif %}
                  </div>
                </div>
              </td>
              <td class="text-end">
                <strong>{{ product.price|cop }}</strong>
              </td>
              <td class="text-center">
                {% if product.stock <= product.min_stock %}
                  <span class="badge bg-danger">{{ product.stock }}</span>
                {% elif product.stock <= product.min_stock|add:10 %}
                  <span class="badge bg-warning text-dark">{{ product.stock }}</span>
                {% else %}
                  <span class="badge bg-success">{{ product.stock }}</span>
                {% endif %}
              </td>
              <td class="text-center">
                {% if product.has_variants %}
                  <span class="badge bg-info">
                    <i class="bi bi-layers"></i> {{ product.variants.count|default:0 }}
                  </span>
                {% else %}
                  <span class="badge bg-secondary">
                    <i class="bi bi-dash"></i>
                  </span>
                {% endif %}
              </td>
              <td class="text-center">
                {% if product.status == "active" %}
                  <span class="badge bg-success">
                    <i class="bi bi-check-circle"></i> Activo
                  </span>
                {% else %}
                  <span class="badge bg-danger">
                    <i class="bi bi-x-circle"></i> Inactivo
                  </span>
                {% endif %}
              </td>
              <td class="text-end">
                <div class="d-flex justify-content-end">
                  {% if perms.products.view_product %}
                    <a href="{% url 'backoffice:products:product_detail' product.pk %}"
                       class="btn btn-sm btn-outline-primary me-1"
                       data-bs-toggle="tooltip"
                       title="Ver producto">
                      <i class="bi bi-eye"></i>
                    </a>
                  {% endif %}

                  {% if perms.products.change_product %}
                    <a href="{% url 'backoffice:products:product_update' product.pk %}"
                       class="btn btn-sm btn-outline-secondary me-1"
                       data-bs-toggle="tooltip"
                       title="Editar producto">
                      <i class="bi bi-pencil"></i>
                    </a>
                  {% endif %}

                  {% if perms.products.delete_product %}
                    <a href="{% url 'backoffice:products:product_delete' product.pk %}"
                       class="btn btn-sm btn-outline-danger"
                       data-bs-toggle="tooltip"
                       title="Eliminar producto">
                      <i class="bi bi-trash"></i>
                    </a>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted py-4">
                <i class="bi bi-inbox display-4 d-block mb-2"></i>
                No se encontraron productos con los filtros aplicados
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Paginación -->
  {% if is_paginated %}
  <nav aria-label="Paginación" class="mt-4">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?{% if querystring %}{{ querystring }}&{% endif %}page=1">
            <i class="bi bi-chevron-double-left"></i>
          </a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.previous_page_number }}">
            <i class="bi bi-chevron-left"></i> Anterior
          </a>
        </li>
      {% endif %}

      <li class="page-item disabled">
        <span class="page-link">
          Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        </span>
      </li>

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.next_page_number }}">
            Siguiente <i class="bi bi-chevron-right"></i>
          </a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.paginator.num_pages }}">
            <i class="bi bi-chevron-double-right"></i>
          </a>
        </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}

</div>
{% endblock %}

{% extends "backoffice/base_backoffice.html" %}
{% load breadcrumbs %}

{% block title %}{{ product.name }} - Detalle{% endblock %}

{% block breadcrumb %}
  {% breadcrumb "Productos|products:product_list" product.name %}
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Encabezado con acciones -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
        <div>
          <h2 class="mb-1">{{ product.name }}</h2>
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <span class="badge bg-light text-dark border">SKU: {{ product.sku }}</span>
            {% if product.status == 'active' %}
              <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Activo</span>
            {% elif product.status == 'inactive' %}
              <span class="badge bg-secondary"><i class="bi bi-pause-circle me-1"></i>Inactivo</span>
            {% else %}
              <span class="badge bg-warning text-dark"><i class="bi bi-file-earmark-text me-1"></i>Borrador</span>
            {% endif %}
            <span class="badge bg-info"><i class="bi bi-layers me-1"></i>{{ product.variants.count }} variantes</span>
          </div>
        </div>

        <div class="d-flex gap-2 flex-wrap">
          <a href="{% url 'backoffice:products:product_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Volver al listado
          </a>
          {% if perms.products.change_product %}
            <a href="{% url 'backoffice:products:product_update' product.pk %}" class="btn btn-outline-primary">
              <i class="bi bi-pencil me-2"></i>Editar
            </a>
          {% endif %}
          {% if perms.products.delete_product %}
            <a href="{% url 'backoffice:products:product_delete' product.pk %}" class="btn btn-outline-danger">
              <i class="bi bi-trash me-2"></i>Eliminar
            </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Galería de imágenes -->
    <div class="col-lg-5">
      <div class="card shadow border-0 rounded-4 h-100">
        <div class="card-body">
          <h5 class="card-title mb-3"><i class="bi bi-image me-2"></i>Galería</h5>

          {% with images=product.images.all %}
            {% if images %}
              {% with carousel_id="productCarousel"|add:product.pk|stringformat:"s" total=images|length %}
                <div id="{{ carousel_id }}" class="carousel slide mb-3" data-bs-ride="false">
                  <div class="carousel-inner rounded-3 overflow-hidden">
                    {% for img in images %}
                      <div class="carousel-item {% if forloop.first %}active{% endif %}">
                        <img src="{{ img.image.url }}" class="d-block w-100 gallery-thumb"
                             style="height: 300px; object-fit: cover;"
                             alt="Imagen {{ forloop.counter }} de {{ product.name }}">
                      </div>
                    {% endfor %}
                  </div>

                  {% if total > 1 %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#{{ carousel_id }}" data-bs-slide="prev">
                      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                      <span class="visually-hidden">Anterior</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#{{ carousel_id }}" data-bs-slide="next">
                      <span class="carousel-control-next-icon" aria-hidden="true"></span>
                      <span class="visually-hidden">Siguiente</span>
                    </button>
                  {% endif %}
                </div>

                <!-- Miniaturas -->
                {% if total > 1 %}
                  <div class="d-flex gap-2 flex-wrap justify-content-center">
                    {% for img in images %}
                      <button type="button" class="btn p-0 border-0"
                              data-bs-target="#{{ carousel_id }}"
                              data-bs-slide-to="{{ forloop.counter0 }}"
                              aria-label="Ir a imagen {{ forloop.counter }}">
                        <img src="{{ img.image.url }}" class="rounded border gallery-thumb"
                             style="width: 60px; height: 60px; object-fit: cover;"
                             alt="Miniatura {{ forloop.counter }}">
                      </button>
                    {% endfor %}
                  </div>
                {% endif %}
              {% endwith %}
            {% else %}
              <div class="ratio ratio-1x1 bg-light rounded-3 d-flex align-items-center justify-content-center">
                <div class="text-center text-muted">
                  <i class="bi bi-image display-4 d-block mb-2"></i>
                  <span>Sin imágenes</span>
                </div>
              </div>
            {% endif %}
          {% endwith %}
        </div>
      </div>
    </div>

    <!-- Información del producto -->
    <div class="col-lg-7">
      <div class="row g-4 h-100">
        <!-- Información general -->
        <div class="col-12">
          <div class="card shadow border-0 rounded-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Información General</h5>

              <div class="row g-3">
                <div class="col-md-8">
                  <div class="mb-3">
                    <strong>Descripción:</strong>
                    <p class="mb-0 text-muted">{{ product.description|default:"Sin descripción disponible" }}</p>
                  </div>

                  <div class="mb-3">
                    <strong>Categorías:</strong>
                    <div class="d-flex flex-wrap gap-1 mt-1">
                      {% for cat in product.categories.all %}
                        <span class="badge bg-light text-dark border">{{ cat.nombre|default:cat.name }}</span>
                      {% empty %}
                        <span class="text-muted">Sin categorías asignadas</span>
                      {% endfor %}
                    </div>
                  </div>

                  {% if product.absolute_category %}
                    <div class="mb-3">
                      <strong>Categoría Principal:</strong>
                      <span class="badge bg-primary ms-2">{{ product.absolute_category.nombre|default:product.absolute_category }}</span>
                    </div>
                  {% endif %}
                </div>

                <div class="col-md-4">
                  <div class="bg-light rounded-3 p-3">
                    <h6 class="mb-2">Datos de Stock</h6>
                    <ul class="list-unstyled mb-0 small">
                      <li class="d-flex justify-content-between mb-1">
                        <span>Stock actual:</span>
                        <strong class="text-primary">{{ product.stock_display|default:product.stock }}</strong>
                      </li>
                      <li class="d-flex justify-content-between mb-1">
                        <span>Stock mínimo:</span>
                        <strong>{{ product.min_stock }}</strong>
                      </li>
                      <li class="d-flex justify-content-between mb-1">
                        <span>Creado:</span>
                        <span>{{ product.created_at|date:"d/m/Y" }}</span>
                      </li>
                      <li class="d-flex justify-content-between">
                        <span>Actualizado:</span>
                        <span>{{ product.updated_at|date:"d/m/Y" }}</span>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Precios -->
        <div class="col-12">
          <div class="card shadow border-0 rounded-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Información de Precios</h5>

              <div class="row g-3">
                <div class="col-sm-6">
                  <div class="border rounded-3 p-3 h-100">
                    <div class="d-flex align-items-center justify-content-between">
                      <div>
                        <small class="text-muted d-block">Precio Base</small>
                        <h4 class="mb-0 text-primary">${{ product.price|floatformat:2 }}</h4>
                      </div>
                      <i class="bi bi-tag display-6 text-muted"></i>
                    </div>
                    {% if product.cost %}
                      <small class="text-muted">Costo: ${{ product.cost|floatformat:2 }}</small>
                    {% endif %}
                  </div>
                </div>

                <div class="col-sm-6">
                  <div class="border rounded-3 p-3 h-100 bg-success bg-opacity-10">
                    <div class="d-flex align-items-center justify-content-between">
                      <div>
                        <small class="text-muted d-block">Precio Final</small>
                        <h4 class="mb-0 text-success">${{ product.get_final_price|floatformat:2 }}</h4>
                      </div>
                      <i class="bi bi-currency-dollar display-6 text-success"></i>
                    </div>
                    <div class="d-flex gap-2 mt-1">
                      {% if product.tax_percentage %}
                        <small class="text-muted">IVA: {{ product.tax_percentage }}%</small>
                      {% endif %}
                      {% if product.markup_percentage %}
                        <small class="text-muted">Ganancia: {{ product.markup_percentage }}%</small>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sección de variantes (solo si tiene variantes) -->
  {% if product.has_variants %}
    <div class="row mt-4">
      <div class="col-12">
        <div class="card shadow border-0 rounded-4">
          <div class="card-header bg-light border-0 rounded-top-4">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="bi bi-layers me-2"></i>Variantes del Producto</h5>
              <div class="d-flex gap-2">
                {% if perms.products.view_productvariant %}
                  <a href="{% url 'backoffice:products:variant_list' product.pk %}" class="btn btn-outline-info btn-sm">
                    <i class="bi bi-eye me-1"></i>Ver todas
                  </a>
                {% endif %}
                {% if perms.products.add_productvariant %}
                  <a href="{% url 'backoffice:products:variant_create' product.pk %}" class="btn btn-primary btn-sm">
                    <i class="bi bi-plus-circle me-1"></i>Nueva variante
                  </a>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                  <tr>
                    <th class="border-0">SKU</th>
                    <th class="border-0">Talla</th>
                    <th class="border-0">Color</th>
                    <th class="border-0">Modificador</th>
                    <th class="border-0">Stock</th>
                    <th class="border-0">Estado</th>
                    {% if perms.products.change_productvariant or perms.products.delete_productvariant %}
                      <th class="border-0 text-center">Acciones</th>
                    {% endif %}
                  </tr>
                </thead>
                <tbody>
                  {% for variant in variants %}
                    <tr>
                      <td><code>{{ variant.sku|default:"—" }}</code></td>
                      <td>{{ variant.size|default:"—" }}</td>
                      <td>{{ variant.color|default:"—" }}</td>
                      <td class="text-mono">${{ variant.price_modifier|floatformat:2 }}</td>
                      <td>
                        <span class="badge {% if variant.stock > 0 %}bg-success{% else %}bg-warning text-dark{% endif %}">
                          {{ variant.stock }}
                        </span>
                      </td>
                      <td>
                        {% if variant.is_active %}
                          <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Activo</span>
                        {% else %}
                          <span class="badge bg-secondary"><i class="bi bi-pause-circle me-1"></i>Inactivo</span>
                        {% endif %}
                      </td>
                      {% if perms.products.change_productvariant or perms.products.delete_productvariant %}
                        <td class="text-center">
                          <div class="btn-group btn-group-sm">
                            {% if perms.products.change_productvariant %}
                              <a href="{% url 'backoffice:products:variant_update' variant.pk %}" class="btn btn-outline-primary">
                                <i class="bi bi-pencil"></i>
                              </a>
                            {% endif %}
                            {% if perms.products.delete_productvariant %}
                              <a href="{% url 'backoffice:products:variant_delete' variant.pk %}" class="btn btn-outline-danger">
                                <i class="bi bi-trash"></i>
                              </a>
                            {% endif %}
                          </div>
                        </td>
                      {% endif %}
                    </tr>
                  {% empty %}
                    <tr>
                      <td colspan="{% if perms.products.change_productvariant or perms.products.delete_productvariant %}7{% else %}6{% endif %}" class="text-center py-4">
                        <div class="text-muted">
                          <i class="bi bi-layers fs-1 d-block mb-2"></i>
                          <p class="mb-2">No hay variantes registradas</p>
                          {% if perms.products.add_productvariant %}
                            <a href="{% url 'backoffice:products:variant_create' product.pk %}" class="btn btn-primary btn-sm">
                              <i class="bi bi-plus-circle me-1"></i>Crear primera variante
                            </a>
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
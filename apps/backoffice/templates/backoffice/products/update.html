{% extends "backoffice/base_backoffice.html" %}
{% load breadcrumbs %}
{% load static %}

{% block title %}Nuevo Producto - {{ object.sku }}{% endblock %}

{% block breadcrumb %}
{% breadcrumb "Productos|backoffice:products:product_list" "Detalle Producto|backoffice:products:product_detail:object.pk" "Actualizar producto" %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/styles_inventario.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Encabezado -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="h4 mb-0 text-dark fw-bold">
            <i class="bi bi-plus-circle me-2 text-primary"></i>Actualizar Producto
          </h2>
          <p class="text-muted mb-0 mt-1">Complete la información del nuevo producto</p>
        </div>
        <a href="{% url 'backoffice:products:product_detail' object.pk %}"
           class="btn btn-outline-secondary"
           data-bs-toggle="tooltip"
           title="Volver al detalle">
          <i class="bi bi-arrow-left me-1"></i>Volver
        </a>
      </div>
    </div>
  </div>

  <!-- Formulario -->
  <div class="card shadow-sm border-0">
    <div class="card-body p-4">
      <form method="post" enctype="multipart/form-data" id="product-form">
        {% csrf_token %}

        <!-- Mostrar errores generales -->
        {% if form.non_field_errors %}
          <div class="alert alert-danger border-left-danger mb-4">
            <div class="d-flex align-items-center">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              <div>
                <strong>Errores en el formulario:</strong>
                {{ form.non_field_errors }}
              </div>
            </div>
          </div>
        {% endif %}

        <!-- Pestañas de navegación -->
        <ul class="nav nav-tabs nav-tabs-custom mb-4" id="productTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab"
                    data-bs-target="#basic" type="button" role="tab">
              <i class="bi bi-info-circle me-1"></i>1. Información Básica
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="pricing-tab" data-bs-toggle="tab"
                    data-bs-target="#pricing" type="button" role="tab">
              <i class="bi bi-currency-dollar me-1"></i>2. Costos y Precios
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="inventory-tab" data-bs-toggle="tab"
                    data-bs-target="#inventory" type="button" role="tab">
              <i class="bi bi-boxes me-1"></i>3. Inventario
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="images-tab" data-bs-toggle="tab"
                    data-bs-target="#images" type="button" role="tab">
              <i class="bi bi-images me-1"></i>4. Imágenes
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="confirm-tab" data-bs-toggle="tab"
                    data-bs-target="#confirm" type="button" role="tab">
              <i class="bi bi-check-circle me-1"></i>5. Confirmar
            </button>
          </li>
        </ul>

        <div class="tab-content" id="productTabContent">
          <!-- 1. Información Básica -->
          <div class="tab-pane fade show active" id="basic" role="tabpanel">
            <div class="row g-4">
              <div class="col-md-6">
                <label for="{{ form.sku.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-upc me-1 text-primary"></i>{{ form.sku.label }}
                </label>
                {{ form.sku }}
                {% if form.sku.errors %}
                  <div class="invalid-feedback d-block">{{ form.sku.errors }}</div>
                {% endif %}
                <small class="form-text text-muted">Código único del producto</small>
              </div>

              <div class="col-md-6">
                <label for="{{ form.name.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-tag me-1 text-primary"></i>{{ form.name.label }}
                </label>
                {{ form.name }}
                {% if form.name.errors %}
                  <div class="invalid-feedback d-block">{{ form.name.errors }}</div>
                {% endif %}
              </div>

              <div class="col-12">
                <label for="{{ form.description.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-card-text me-1 text-primary"></i>{{ form.description.label }}
                </label>
                {{ form.description }}
                {% if form.description.errors %}
                  <div class="invalid-feedback d-block">{{ form.description.errors }}</div>
                {% endif %}
              </div>

              <div class="col-md-6">
                <label for="{{ form.absolute_category.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-folder me-1 text-primary"></i>{{ form.absolute_category.label }}
                </label>
                {{ form.absolute_category }}
                {% if form.absolute_category.errors %}
                  <div class="invalid-feedback d-block">{{ form.absolute_category.errors }}</div>
                {% endif %}
                <small class="form-text text-muted">Categoría principal del producto</small>
              </div>

              <div class="col-md-6">
                <label for="{{ form.categories.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-tags me-1 text-primary"></i>Categorías Secundarias
                </label>
                {{ form.categories }}
                {% if form.categories.errors %}
                  <div class="invalid-feedback d-block">{{ form.categories.errors }}</div>
                {% endif %}
                <small class="form-text text-muted">Puede seleccionar múltiples categorías</small>
              </div>
            </div>
          </div>

          <!-- 2. Costos y Precios -->
          <div class="tab-pane fade" id="pricing" role="tabpanel">
            <div class="row g-4">
              <div class="col-md-4">
                <label for="{{ form.cost.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-calculator me-1 text-warning"></i>{{ form.cost.label }}
                </label>
                {{ form.cost }}
                {% if form.cost.errors %}
                  <div class="invalid-feedback d-block">{{ form.cost.errors }}</div>
                {% endif %}
              </div>

              <div class="col-md-4">
                <label for="{{ form.tax_percentage.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-percent me-1 text-warning"></i>{{ form.tax_percentage.label }}
                </label>
                {{ form.tax_percentage }}
                {% if form.tax_percentage.errors %}
                  <div class="invalid-feedback d-block">{{ form.tax_percentage.errors }}</div>
                {% endif %}
              </div>

              <div class="col-md-4">
                <label for="{{ form.markup_percentage.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-graph-up me-1 text-success"></i>{{ form.markup_percentage.label }}
                </label>
                {{ form.markup_percentage }}
                {% if form.markup_percentage.errors %}
                  <div class="invalid-feedback d-block">{{ form.markup_percentage.errors }}</div>
                {% endif %}
              </div>

              <div class="col-12">
                <div class="alert alert-info border-left-primary">
                  <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-lightbulb me-2"></i>
                    <strong>Precio Sugerido: </strong>
                    <span id="suggested-price" class="fw-bold ms-2">—</span>
                    <button type="button" class="btn btn-sm btn-outline-success ms-3" id="accept-price">
                      <i class="bi bi-check2 me-1"></i>Aceptar
                    </button>
                  </div>
                  <small class="text-muted">Se calcula automáticamente: (Costo + IVA) + Margen de ganancia</small>
                </div>
              </div>

              <div class="col-md-6">
                <label for="{{ form.price.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-currency-dollar me-1 text-success"></i>{{ form.price.label }}
                </label>
                {{ form.price }}
                {% if form.price.errors %}
                  <div class="invalid-feedback d-block">{{ form.price.errors }}</div>
                {% endif %}
                <small class="form-text text-muted">Puede usar el precio sugerido o definir uno manualmente</small>
              </div>
            </div>
          </div>

          <!-- 3. Inventario -->
          <div class="tab-pane fade" id="inventory" role="tabpanel">
            <div class="row g-4">
              <div class="col-12">
                <div class="form-check form-switch">
                  {{ form.has_variants }}
                  <label class="form-check-label fw-semibold" for="{{ form.has_variants.id_for_label }}">
                    <i class="bi bi-collection me-1 text-info"></i>{{ form.has_variants.label }}
                  </label>
                  <small class="form-text text-muted d-block mt-1">
                    Si se activa, el stock se controlará por variantes individuales
                  </small>
                </div>
              </div>

              <div class="col-md-6 field-stock">
                <label for="{{ form.stock.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-boxes me-1 text-primary"></i>{{ form.stock.label }}
                </label>
                {{ form.stock }}
                {% if form.stock.errors %}
                  <div class="invalid-feedback d-block">{{ form.stock.errors }}</div>
                {% endif %}
              </div>

              <div class="col-md-6">
                <label for="{{ form.min_stock.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-exclamation-triangle me-1 text-warning"></i>{{ form.min_stock.label }}
                </label>
                {{ form.min_stock }}
                {% if form.min_stock.errors %}
                  <div class="invalid-feedback d-block">{{ form.min_stock.errors }}</div>
                {% endif %}
                <small class="form-text text-muted">Se enviará alerta cuando el stock sea menor o igual a este valor</small>
              </div>
            </div>
          </div>

        <!-- 4. Imágenes -->
        <div class="tab-pane fade" id="images" role="tabpanel">
          <div class="mb-4">
            <h5 class="fw-semibold mb-3">
              <i class="bi bi-images me-2 text-primary"></i>Galería de Imágenes
            </h5>

            {{ image_formset.management_form }}
            {% if image_formset.non_form_errors %}
              <div class="alert alert-danger py-2 small mb-3">
                {% for error in image_formset.non_form_errors %}
                  <div>{{ error }}</div>
                {% endfor %}
              </div>
            {% endif %}

            <!-- Empty form (se clona con JS) -->
            <div id="image-empty-form" style="display:none;">
              <div class="col-lg-3 col-md-4 col-sm-6 image-card">
                <div class="card shadow-sm border-0 h-100" style="border-radius: 12px; overflow:hidden;">
                  <div class="bg-light d-flex align-items-center justify-content-center"
                       style="height:150px; overflow:hidden;">
                    <img src="{% static 'img/placeholder.png' %}"
                         class="preview gallery-thumb"
                         style="max-height:100%; max-width:100%; object-fit:contain;">
                  </div>
                  <div class="card-body p-2" style="font-size: 0.9rem;">
                    {{ image_formset.empty_form.id }}
                    <div class="mb-2">
                      {{ image_formset.empty_form.image }}
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <div class="form-check form-check-sm">
                        {{ image_formset.empty_form.is_main }}
                        <label class="form-check-label small fw-semibold" for="{{ image_formset.empty_form.is_main.id_for_label }}">Principal</label>
                      </div>
                      <div>
                        <label class="form-label small fw-semibold mb-0" for="{{ image_formset.empty_form.order.id_for_label }}">Orden</label>
                        {{ image_formset.empty_form.order }}
                      </div>
                    </div>
                    {{ image_formset.empty_form.DELETE }}
                  </div>
                  <div class="card-footer bg-light p-2 text-center">
                    <button type="button" class="btn btn-sm btn-outline-danger btn-delete">
                      <i class="bi bi-trash me-1"></i>Eliminar
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Galería existente -->
            <div class="row g-3" id="image-gallery">
              {% for form in image_formset %}
                <div class="col-lg-3 col-md-4 col-sm-6 image-card">
                  <div class="card shadow-sm border-0 h-100" style="border-radius: 12px; overflow:hidden;">
                    <div class="bg-light d-flex align-items-center justify-content-center"
                         style="height:150px; overflow:hidden;">
                      {% if form.instance.pk and form.instance.image %}
                        <img src="{{ form.instance.image.url }}"
                             class="preview gallery-thumb"
                             style="max-height:100%; max-width:100%; object-fit:contain;">
                      {% else %}
                        <img src="{% static 'img/placeholder.png' %}"
                             class="preview gallery-thumb"
                             style="max-height:100%; max-width:100%; object-fit:contain;">
                      {% endif %}
                    </div>
                    <div class="card-body p-2" style="font-size: 0.9rem;">
                      {{ form.id }}
                      <div class="mb-2">
                        {{ form.image }}
                        {% if form.image.errors %}
                          <div class="invalid-feedback d-block">{{ form.image.errors }}</div>
                        {% endif %}
                      </div>
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="form-check form-check-sm">
                          {{ form.is_main }}
                          <label class="form-check-label small fw-semibold" for="{{ form.is_main.id_for_label }}">Principal</label>
                        </div>
                        <div>
                          <label class="form-label small fw-semibold mb-0" for="{{ form.order.id_for_label }}">Orden</label>
                          {{ form.order }}
                        </div>
                      </div>
                      {{ form.DELETE }}
                    </div>
                    <div class="card-footer bg-light p-2 text-center">
                      <button type="button" class="btn btn-sm btn-outline-danger btn-delete" data-bs-toggle="tooltip" title="Eliminar imagen">
                        <i class="bi bi-trash me-1"></i>Eliminar
                      </button>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>

            <div class="mt-4 text-center">
              <button type="button" class="btn btn-outline-primary" id="add-image">
                <i class="bi bi-plus-circle me-1"></i>Agregar Imagen
              </button>
              <small class="form-text text-muted d-block mt-2">
                Puede definir una imagen principal y el orden de aparición
              </small>
            </div>
          </div>
        </div>


          <!-- 5. Confirmar -->
          <div class="tab-pane fade" id="confirm" role="tabpanel">
            <div class="row g-4">
              <div class="col-md-6">
                <label for="{{ form.status.id_for_label }}" class="form-label fw-semibold">
                  <i class="bi bi-toggle-on me-1 text-success"></i>{{ form.status.label }}
                </label>
                {{ form.status }}
                {% if form.status.errors %}
                  <div class="invalid-feedback d-block">{{ form.status.errors }}</div>
                {% endif %}
              </div>

              <div class="col-12">
                <div class="alert alert-success border-left-success">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-check-circle me-2"></i>
                    <div>
                      <strong>¿Listo para Actualizar el producto?</strong>
                      <p class="mb-0 mt-1">Revise que toda la información sea correcta antes de guardar.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Botones de acción -->
        <div class="row mt-5">
          <div class="col-12">
            <div class="d-flex justify-content-between align-items-center border-top pt-4">
                <a href="{% url 'backoffice:products:product_detail' object.pk %}"
                   class="btn btn-outline-secondary px-4">
                  <i class="bi bi-x-circle me-1"></i>Cancelar
                </a>
              <button type="submit" class="btn btn-success px-4">
                <i class="bi bi-check-circle me-1"></i>Actualizar Producto
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // === Cálculo dinámico de precio sugerido ===
  function calcSuggested() {
    const cost = parseFloat(document.getElementById("id_cost").value) || 0;
    const tax = parseFloat(document.getElementById("id_tax_percentage").value) || 0;
    const margin = parseFloat(document.getElementById("id_markup_percentage").value) || 0;

    const costWithTax = cost * (1 + tax/100);
    const suggested = costWithTax * (1 + margin/100);

    document.getElementById("suggested-price").innerText = "$" + suggested.toFixed(2);
    return suggested;
  }

  document.getElementById("id_cost").addEventListener("input", calcSuggested);
  document.getElementById("id_tax_percentage").addEventListener("change", calcSuggested);
  document.getElementById("id_markup_percentage").addEventListener("input", calcSuggested);
  document.getElementById("accept-price").addEventListener("click", function() {
    document.getElementById("id_price").value = calcSuggested().toFixed(2);
  });

  // === Mostrar/ocultar campo stock según has_variants ===
  const hasVariants = document.getElementById("id_has_variants");
  const stockField = document.querySelector(".field-stock");

  function toggleStock() {
    if (hasVariants.checked) {
      stockField.style.display = "none";
    } else {
      stockField.style.display = "block";
    }
  }
  toggleStock();
  hasVariants.addEventListener("change", toggleStock);

  // === Formset dinámico de imágenes ===
  const formPrefix = "{{ image_formset.prefix }}";
  const totalFormsInput = document.getElementById("id_" + formPrefix + "-TOTAL_FORMS");
  const gallery = document.getElementById("image-gallery");
  const addButton = document.getElementById("add-image");

  function addImageForm() {
    let formCount = parseInt(totalFormsInput.value, 10);
    let templateHtml = document.getElementById("image-empty-form").innerHTML;
    let newHtml = templateHtml.replace(/__prefix__/g, formCount);

    const col = document.createElement("div");
    col.className = "col-lg-3 col-md-4 col-sm-6 image-card";
    col.innerHTML = `
      <div class="card h-100 shadow-sm border-0">
        <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 180px;">
          <img src="{% static 'img/placeholder.png' %}" class="img-fluid preview gallery-thumb">
        </div>
        <div class="card-body p-3">
          <div class="mb-2">${newHtml}</div>
        </div>
        <div class="card-footer bg-light p-2 text-center">
          <button type="button" class="btn btn-sm btn-outline-danger btn-delete" data-bs-toggle="tooltip" title="Eliminar imagen">
            <i class="bi bi-trash me-1"></i>Eliminar
          </button>
        </div>
      </div>
    `;

    gallery.appendChild(col);
    totalFormsInput.value = formCount + 1;

    initPreview(col);
    initDelete(col);

    // Abrir file dialog inmediatamente
    const fileInput = col.querySelector('input[type="file"]');
    if (fileInput) fileInput.click();
  }

  function initPreview(container) {
    const fileInput = container.querySelector('input[type="file"]');
    const previewImg = container.querySelector(".preview");

    if (fileInput) {
      fileInput.addEventListener("change", function () {
        if (this.files && this.files[0]) {
          const reader = new FileReader();
          reader.onload = e => { previewImg.src = e.target.result; };
          reader.readAsDataURL(this.files[0]);
        }
      });
    }
  }

  function initDelete(container) {
    const btnDelete = container.querySelector(".btn-delete");
    const deleteInput = container.querySelector("input[type=checkbox][name$='-DELETE']");

    btnDelete.addEventListener("click", function () {
      if (deleteInput) {
        deleteInput.checked = true;
        container.style.display = "none";
      } else {
        container.remove();
      }
    });
  }

  // Inicializar en los forms ya existentes
  document.querySelectorAll(".image-card").forEach(initPreview);
  document.querySelectorAll(".image-card").forEach(initDelete);

  // Botón agregar
  addButton.addEventListener("click", addImageForm);

  // Inicializar tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});
</script>
{% endblock %}
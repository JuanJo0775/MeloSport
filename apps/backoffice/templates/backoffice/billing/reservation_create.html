{% extends "backoffice/base_backoffice.html" %}
{% load breadcrumbs %}
{% load money %}

{% block title %}Nuevo Apartado{% endblock %}

{% block breadcrumb %}
  {% breadcrumb "FacturaciÃ³n|backoffice:billing:reservation_list" "Apartados|backoffice:billing:reservation_list" "Nuevo apartado" %}
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Crear Apartado</h5>
      <a href="{% url 'backoffice:billing:reservation_list' %}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left me-1"></i>Volver a Apartados
      </a>
    </div>

    <div class="card-body">
      <form method="post" novalidate id="reservation-form">
        {% csrf_token %}
        {{ form.media }}
        {{ items_formset.media }}

        {% if form.non_field_errors %}
          <div class="alert alert-danger">{{ form.non_field_errors }}</div>
        {% endif %}

        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label fw-semibold">{{ form.client_first_name.label }}</label>
            {{ form.client_first_name }}
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">{{ form.client_last_name.label }}</label>
            {{ form.client_last_name }}
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">{{ form.client_phone.label }}</label>
            {{ form.client_phone }}
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">{{ form.amount_deposited.label }}</label>
            {{ form.amount_deposited }}
            <div class="form-text">Monto abonado (opcional)</div>
          </div>
        </div>

        <hr />

        <h6 class="mb-3">Productos seleccionados</h6>
        {{ items_formset.management_form }}

        <div id="items-list" class="row g-3">
          {# Render existing forms (si los hay) #}
          {% for f in items_formset.forms %}
            <div class="col-md-6 item-card">
              <div class="card h-100">
                <div class="card-body">
                  <div class="mb-2">{{ f.product }}</div>
                  <div class="mb-2 variant-field">{{ f.variant }}</div>
                  <div class="row g-2">
                    <div class="col">{{ f.quantity.label_tag }}{{ f.quantity }}</div>
                    <div class="col">{{ f.unit_price.label_tag }}{{ f.unit_price }}</div>
                  </div>
                </div>
                <div class="card-footer text-end">
                  <button type="button" class="btn btn-outline-danger btn-sm remove-item">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
                {{ f.id }} {{ f.DELETE }}
              </div>
            </div>
          {% endfor %}
        </div>

        <hr />

        {# ðŸ”¹ AquÃ­ cargamos el navegador de productos completo (con filtros, bÃºsqueda y tarjetas) #}
        <h6 class="mb-3">Buscar y agregar productos</h6>
        <div id="product-browser"
             class="row g-3"
             style="max-height: 450px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: .5rem; padding: 1rem;">
          <div class="text-center w-100 text-muted">Cargando productos...</div>
        </div>

        <div class="mt-3 text-end">
          <button type="button" class="btn btn-primary" id="add-selected-products">
            <i class="bi bi-plus-circle"></i> Agregar seleccionados
          </button>
        </div>

        <hr />
        <h6>Vista previa</h6>
        <div id="preview-list" class="list-group mb-3"></div>

        <div class="mt-4 d-flex justify-content-end gap-2">
          <a href="{% url 'backoffice:billing:reservation_list' %}" class="btn btn-outline-secondary">Cancelar</a>
          <button type="submit" class="btn btn-primary">Guardar Apartado</button>
        </div>
      </form>
    </div>
  </div>
</div>

{# ---------------- Hidden prototype from empty_form ---------------- #}
<div id="empty-form-template" style="display:none;">
  {{ items_formset.empty_form.as_p|escapejs }}
</div>
{% endblock %}

{% block extra_js %}
<script>
(function () {
  const productListEl = document.getElementById('product-browser');
  const addSelectedBtn = document.getElementById('add-selected-products');

  const browserUrl = "{% url 'backoffice:billing:products_browser' %}";
  const productDetailUrlTemplate = "{% url 'backoffice:billing:product_detail_json' 0 %}".replace('/0/', '/{id}/');

  const emptyFormEscaped = document.getElementById('empty-form-template').innerText || '';
  function decodeEscapedJs(s) {
    try { return s.replace(/\\n/g, '\n').replace(/\\"/g, '"').replace(/\\'/g, "'"); }
    catch (e) { return s; }
  }
  const emptyFormHtml = decodeEscapedJs(emptyFormEscaped);

  // ðŸ”¹ cargar productos automÃ¡ticamente al entrar
  function loadProductCards(params = {}) {
    const query = new URLSearchParams(params).toString();
    productListEl.innerHTML = '<div class="text-center w-100 py-4 text-muted">Cargando productos...</div>';
    fetch(browserUrl + (query ? '?' + query : ''), { credentials: 'same-origin' })
      .then(r => r.text())
      .then(html => { productListEl.innerHTML = html; })
      .catch(err => {
        productListEl.innerHTML = '<div class="text-danger w-100 text-center">Error cargando productos</div>';
        console.error(err);
      });
  }
  loadProductCards(); // ðŸ‘‰ primera carga automÃ¡tica

  // ðŸ”¹ evento delegado para filtros/bÃºsqueda dentro del navegador
  document.addEventListener('submit', function(e){
    if(e.target.id === 'product-filters-form'){
      e.preventDefault();
      const formData = new FormData(e.target);
      const params = Object.fromEntries(formData.entries());
      loadProductCards(params);
    }
  });

  // agregar seleccionados
  addSelectedBtn.addEventListener('click', async function () {
    const productChecks = productListEl.querySelectorAll('input.product-select-checkbox:checked');
    const variantChecks = productListEl.querySelectorAll('input.variant-select-checkbox:checked');
    if (!productChecks.length && !variantChecks.length) {
      alert('Selecciona al menos un producto o variante.');
      return;
    }

    const requests = [];
    productChecks.forEach(ch => {
      const qtyInput = ch.closest('.border, .card-body').querySelector('.product-qty');
      requests.push({ id: ch.value, qty: qtyInput ? parseInt(qtyInput.value, 10) : 1, type: 'product' });
    });
    variantChecks.forEach(ch => {
      const qtyInput = ch.closest('.border, .card-body').querySelector('.variant-qty');
      requests.push({ id: ch.value, qty: qtyInput ? parseInt(qtyInput.value, 10) : 1, type: 'variant' });
    });

    try {
      for (let req of requests) {
        const url = productDetailUrlTemplate.replace('{id}', req.id);
        const data = await fetch(url, { credentials: 'same-origin' }).then(r => r.json());
        data.qty = req.qty;
        data.type = req.type;
        addItemFromProductData(data);
      }
      updatePreview();
    } catch (e) {
      console.error(e);
      alert('Error al obtener datos de productos seleccionados.');
    }
  });

  function addItemFromProductData(product) {
    const totalFormsEl = document.getElementById('id_' + '{{ items_formset.prefix }}-TOTAL_FORMS');
    let index = parseInt(totalFormsEl.value, 10);
    let html = emptyFormHtml.replace(/__prefix__/g, index);

    const tmp = document.createElement('div');
    tmp.innerHTML = html;

    const productSelect = tmp.querySelector(`select[name$="-product"]`);
    const variantSelect = tmp.querySelector(`select[name$="-variant"]`);
    const qtyInput = tmp.querySelector(`input[name$="-quantity"]`);
    const priceInput = tmp.querySelector(`input[name$="-unit_price"]`);

    if (productSelect) {
      let opt = productSelect.querySelector(`option[value="${product.id}"]`);
      if (!opt) {
        opt = document.createElement('option');
        opt.value = product.id;
        opt.text = product.name + (product.sku ? ' â€¢ ' + product.sku : '');
        productSelect.appendChild(opt);
      }
      productSelect.value = product.id;
    }

    if (variantSelect) {
      variantSelect.innerHTML = '';
      if (product.variants && product.variants.length) {
        product.variants.forEach(v => {
          const o = document.createElement('option');
          o.value = v.id;
          o.text = v.label;
          variantSelect.appendChild(o);
        });
        if (product.type === 'variant') {
          variantSelect.value = product.id;
        }
      }
    }

    if (qtyInput) qtyInput.value = product.qty || 1;
    if (priceInput) priceInput.value = product.price || 0;

    const wrapper = document.createElement('div');
    wrapper.className = 'col-md-6 item-card';
    wrapper.innerHTML = `
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex gap-2 align-items-center mb-2">
            ${product.image ? `<img src="${product.image}" style="width:48px;height:48px;object-fit:cover;border-radius:4px">` : ''}
            <div>
              <div class="fw-semibold">${product.name}</div>
              ${product.sku ? `<small class="text-muted">${product.sku}</small>` : ''}
            </div>
          </div>
          <div class="mb-2 variant-field"></div>
        </div>
        <div class="card-footer text-end">
          <button type="button" class="btn btn-outline-danger btn-sm remove-item"><i class="bi bi-trash"></i></button>
        </div>
      </div>
    `;

    const cardBody = wrapper.querySelector('.card-body');
    if (variantSelect) {
      const variantContainer = document.createElement('div');
      variantContainer.className = 'mb-2';
      variantContainer.appendChild(variantSelect);
      cardBody.appendChild(variantContainer);
    }

    const row = document.createElement('div');
    row.className = 'row g-2';
    const col1 = document.createElement('div'); col1.className = 'col';
    const col2 = document.createElement('div'); col2.className = 'col';
    const qtyLabel = document.createElement('label');
    qtyLabel.className = 'form-label small';
    qtyLabel.innerText = 'Cantidad';
    col1.appendChild(qtyLabel); col1.appendChild(qtyInput);
    const priceLabel = document.createElement('label');
    priceLabel.className = 'form-label small';
    priceLabel.innerText = 'Precio unitario';
    col2.appendChild(priceLabel); col2.appendChild(priceInput);
    row.appendChild(col1); row.appendChild(col2);
    cardBody.appendChild(row);

    const hiddenFields = tmp.querySelectorAll('input[type="hidden"], input[type="checkbox"].form-check-input');
    hiddenFields.forEach(h => wrapper.appendChild(h));

    document.getElementById('items-list').appendChild(wrapper);
    totalFormsEl.value = index + 1;
  }

  // eliminar item
  document.addEventListener('click', function (e) {
    if (e.target.closest && e.target.closest('.remove-item')) {
      const card = e.target.closest('.item-card');
      if (!card) return;
      const deleteInput = card.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if (deleteInput) {
        deleteInput.checked = true;
        card.style.display = 'none';
      } else {
        card.remove();
        const totalFormsEl = document.getElementById('id_' + '{{ items_formset.prefix }}-TOTAL_FORMS');
        totalFormsEl.value = parseInt(totalFormsEl.value, 10) - 1;
      }
      updatePreview();
    }
  });

  // vista previa
  function updatePreview() {
    const preview = document.getElementById('preview-list');
    preview.innerHTML = '';
    const cards = document.querySelectorAll('#items-list .item-card');
    cards.forEach(c => {
      if (c.style.display === 'none') return;
      const name = c.querySelector('.fw-semibold') ? c.querySelector('.fw-semibold').innerText : '';
      const sku = c.querySelector('.text-muted') ? c.querySelector('.text-muted').innerText : '';
      const qty = c.querySelector('input[name$="-quantity"]') ? c.querySelector('input[name$="-quantity"]').value : '';
      const price = c.querySelector('input[name$="-unit_price"]') ? c.querySelector('input[name$="-unit_price"]').value : '';
      if (name) {
        const li = document.createElement('div');
        li.className = 'list-group-item d-flex justify-content-between';
        li.innerHTML = `<div>${name} ${sku ? '<small class="text-muted"> ' + sku + '</small>' : ''}</div><div>${qty || 0} x ${price || 0}</div>`;
        preview.appendChild(li);
      }
    });
  }

  document.addEventListener('change', function (e) {
    if (e.target.closest && e.target.closest('#items-list')) updatePreview();
  });
})();
</script>
{% endblock %}

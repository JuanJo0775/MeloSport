{% extends "backoffice/base_backoffice.html" %}
{% load static money %}
{% load breadcrumbs %}

{% block title %}Crear Reserva{% endblock %}

{% block breadcrumb %}
  {% breadcrumb "Apartados|backoffice:billing:reservation_list" "Nueva reserva" %}
{% endblock %}

{% block content %}
<div class="row">
  <!-- FORMULARIO CLIENTE + PREVIEW -->
  <div class="col-lg-6">
    <form method="post" id="reservation-form" novalidate>
      {% csrf_token %}
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">Datos del cliente</h5>

          <div class="mb-3">
            {{ form.client_first_name.label_tag }}
            {{ form.client_first_name }}
          </div>
          <div class="mb-3">
            {{ form.client_last_name.label_tag }}
            {{ form.client_last_name }}
          </div>
          <div class="mb-3">
            {{ form.client_phone.label_tag }}
            {{ form.client_phone }}
          </div>

          <hr>

          <h6>Vista previa de productos seleccionados</h6>
          <div class="table-responsive mb-3">
            <table class="table table-sm align-middle" id="selected-products-table">
              <thead>
                <tr>
                  <th>Imagen</th>
                  <th>Producto / Variante</th>
                  <th>Cantidad</th>
                  <th>Precio unitario</th>
                  <th>Subtotal</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr class="text-muted" id="no-products-row">
                  <td colspan="6" class="text-center">No hay productos seleccionados.</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="mb-2 d-flex justify-content-between">
            <div>
              <strong>Total a pagar:</strong>
              <div id="total-display" class="fs-5">$ 0</div>
            </div>
            <div>
              <strong>Abono mínimo (20%):</strong>
              <div id="min-deposit-display" class="fs-6">$ 0</div>
            </div>
          </div>

          <div class="mb-3">
            {{ form.amount_deposited.label_tag }}
            {{ form.amount_deposited }}
            <div class="form-text">Ingrese el abono en pesos.</div>
          </div>

          <div class="mb-3" id="due-date-indicator">
            <span id="due-message" class="badge bg-info text-dark">Reserva válida por 3 días hábiles</span>
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary" id="save-reservation-btn">Guardar Reserva</button>
            <button type="button" class="btn btn-outline-secondary" id="toggle-products-panel-btn">Mostrar/Ocultar panel de productos</button>
          </div>
        </div>
      </div>

      <div id="items-formset-area" class="d-none">
        {{ items_formset.management_form }}
        <div id="items-forms-container">
          {% for f in items_formset.forms %}
            {{ f.as_p }}
          {% endfor %}
        </div>
        <textarea id="empty-item-template" class="d-none">{{ items_formset.empty_form.as_p|escapejs }}</textarea>
      </div>
    </form>
  </div>

  <!-- PANEL SCROLLEABLE PRODUCTOS -->
  <div class="col-lg-6">
    <div class="card" id="products-panel" style="height:80vh; overflow:auto;">
      <div class="card-body">
        <div class="d-flex mb-3 gap-2">
          <input type="text" id="product-search" class="form-control" placeholder="Buscar por SKU, nombre o descripción">
          <select id="product-type-filter" class="form-select" style="max-width:150px;">
            <option value="all">Todos</option>
            <option value="simple">Sin variantes</option>
            <option value="variants">Con variantes</option>
          </select>
          <div class="form-check align-self-center ms-2">
            <input class="form-check-input" type="checkbox" id="in-stock-only" checked>
            <label class="form-check-label" for="in-stock-only">Solo en stock</label>
          </div>
        </div>

        <div id="products-container">
          <div class="text-center text-muted">Cargando productos...</div>
        </div>

        <!-- paginación -->
        <nav class="mt-3">
          <ul class="pagination justify-content-center" id="pagination-container"></ul>
        </nav>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  window.RESERVATION_CONFIG = {
    productsApiUrl: "{{ products_api_url }}",
    csrfToken: "{{ csrf_token }}",
    prefix: "items"
  };
</script>
<script src="{% static 'js/reservation_create.js' %}"></script>
{% endblock %}

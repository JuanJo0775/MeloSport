{% extends "backoffice/base_backoffice.html" %}
{% load static %}
{% load money %}
{% load breadcrumbs %}

{% block title %}Crear Reserva{% endblock %}

{% block breadcrumb %}
  {% breadcrumb "Reservas|backoffice:billing:reservation_list" "Crear Reserva" %}
{% endblock %}

{% block content %}
<div id="reservation-page" class="container-fluid py-4">

  <!-- FORMULARIO PRINCIPAL -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h4 class="mb-4">Nueva Reserva</h4>

      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} small">{{ message }}</div>
        {% endfor %}
      {% endif %}

      <form id="reservation-form" method="post" novalidate>
        {% csrf_token %}

        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label">Nombre</label>
            {{ form.client_first_name }}
          </div>
          <div class="col-md-4">
            <label class="form-label">Apellido</label>
            {{ form.client_last_name }}
          </div>
          <div class="col-md-4">
            <label class="form-label">Teléfono</label>
            {{ form.client_phone }}
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Abono realizado</label>
          {{ form.amount_deposited }}
          <div class="form-text">Abono mínimo sugerido: <span id="min-deposit-display">$ 0</span></div>
        </div>

        <!-- formset -->
        {{ items_formset.management_form }}
        <div id="items-forms-container" class="d-none">
          {% for f in items_formset.forms %}
            <div class="form-row">{{ f.as_p }}</div>
          {% endfor %}
        </div>

        <!-- TABLA DE PRODUCTOS SELECCIONADOS -->
        <div class="table-responsive mb-3">
          <table class="table table-sm align-middle" id="selected-products-table">
            <thead class="table-light small">
              <tr>
                <th style="width:60px;"></th>
                <th>Producto / Variante</th>
                <th class="text-center" style="width:110px">Cantidad</th>
                <th class="text-end" style="width:120px">Precio</th>
                <th class="text-end" style="width:120px">Subtotal</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <td colspan="4" class="text-end fw-bold">Total:</td>
                <td class="text-end fw-bold" id="total-display">$ 0</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>

        <p id="due-message" class="small text-muted mb-3">Seleccione productos para calcular vencimiento.</p>

        <div class="d-flex gap-2">
          <button class="btn btn-primary">Guardar Reserva</button>
          <a href="{% url 'backoffice:billing:reservation_list' %}" class="btn btn-outline-secondary">Cancelar</a>
        </div>
      </form>
    </div>
  </div>

  <!-- PANEL DE PRODUCTOS -->
  <div class="card shadow-sm">
    <div class="card-header bg-light">
      <!-- Filtros y búsqueda -->
      <form method="get" class="d-flex flex-wrap gap-2 align-items-center">
        <div class="input-group input-group-sm" style="max-width: 320px;">
          <input name="q" value="{{ current_q }}" type="text" class="form-control" placeholder="Buscar por nombre o SKU">
        </div>
        <select name="type" class="form-select form-select-sm" style="width:200px;" onchange="this.form.submit()">
          <option value="all" {% if current_filter_type == "all" %}selected{% endif %}>Todos</option>
          <option value="simple" {% if current_filter_type == "simple" %}selected{% endif %}>Sin variantes</option>
          <option value="variants" {% if current_filter_type == "variants" %}selected{% endif %}>Con variantes</option>
        </select>
        <button type="submit" class="btn btn-sm btn-primary">Filtrar</button>
        <a href="{% url 'backoffice:billing:reservation_create' %}" class="btn btn-sm btn-outline-secondary">Limpiar filtros</a>
      </form>
    </div>

    <div class="card-body" style="max-height: 500px; overflow-y: auto;">
      <div id="products-container" class="row g-3">
        {% for p in products %}
          <div class="col-12 col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm">
              <img src="{{ p.get_main_image_url|default:p.images.first.image.url|default:'/static/img/no-image.png' }}"
                   class="card-img-top" alt="{{ p.name }}" style="height:130px; object-fit:cover;">
              <div class="card-body">
                <h6 class="card-title mb-1">{{ p.name }}</h6>
                <div class="small text-muted mb-1">SKU: {{ p.sku }}</div>
                <div class="small text-muted mb-2">Stock: {{ p.stock|default:"-" }}</div>

                {% if p.variants.exists %}
                  <table class="table table-sm table-striped align-middle mb-0">
                    <tbody>
                      {% for v in p.variants.all %}
                        <tr>
                          <td>
                            <div class="fw-semibold small">
                              {% if v.size %}Talla: {{ v.size }}{% endif %}
                              {% if v.color %}{% if v.size %}, {% endif %}Color: {{ v.color }}{% endif %}
                            </div>
                            <div class="text-muted small">SKU: {{ v.sku }}</div>
                          </td>
                          <td class="text-end">{{ v.price|default:p.price|cop }}</td>
                          <td class="text-muted">Stock: {{ v.stock }}</td>
                          <td style="width:70px;">
                            <input type="number" min="1" value="1" class="form-control form-control-sm variant-qty-input">
                          </td>
                          <td>
                            <button class="btn btn-sm btn-primary btn-add-variant"
                                    data-product='{"id":{{ p.pk }},"name":"{{ p.name|escapejs }}","sku":"{{ p.sku|escapejs }}"}'
                                    data-variant='{"id":{{ v.pk }},
                                                   "label":"{% if v.size %}Talla: {{ v.size }}{% endif %}{% if v.color %}{% if v.size %}, {% endif %}Color: {{ v.color }}{% endif %}",
                                                   "sku":"{{ v.sku|escapejs }}",
                                                   "stock":{{ v.stock|default:0 }},
                                                   "price":"{{ v.price|default:p.price }}"}'>
                              Agregar
                            </button>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% else %}
                  <div class="mb-2">Precio: <strong>{{ p.price|cop }}</strong></div>
                  <div class="d-flex gap-2">
                    <input type="number" min="1" value="1" class="form-control form-control-sm simple-qty" style="width:80px;">
                    <button class="btn btn-sm btn-primary btn-add-simple"
                            data-product='{"id":{{ p.pk }},
                                           "name":"{{ p.name|escapejs }}",
                                           "sku":"{{ p.sku|escapejs }}",
                                           "price":"{{ p.price }}",
                                           "stock":{{ p.stock|default:0 }}}'>
                      Agregar
                    </button>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% empty %}
          <div class="col-12 text-center text-muted">No hay productos disponibles.</div>
        {% endfor %}
      </div>

      <!-- Paginación -->
      {% if is_paginated %}
        <nav class="mt-3">
          <ul class="pagination pagination-sm">
            {% for num in paginator.page_range %}
              <li class="page-item {% if num == page_obj.number %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}&{{ querystring }}">{{ num }}</a>
              </li>
            {% endfor %}
          </ul>
        </nav>
      {% endif %}
    </div>
  </div>

  <textarea id="empty-item-template" style="display:none;">{{ items_formset.empty_form.as_p|escape }}</textarea>
</div>
{% endblock %}

{% block extra_js %}
<script>
  window.RESERVATION_CONFIG = { prefix: "items" };
</script>
<script src="{% static 'js/reservation_create.js' %}"></script>
{% endblock %}

{% extends "backoffice/base_backoffice.html" %}
{% load static %}
{% load money %}
{% load breadcrumbs %}

{% block title %}Crear Reserva{% endblock %}

{% block breadcrumb %}
  {% breadcrumb "Reservas|backoffice:billing:reservation_list" "Crear Reserva" %}
{% endblock %}

{% block content %}
<div id="reservation-page" class="container-fluid py-4">

  <!-- FORMULARIO PRINCIPAL -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h4 class="mb-4">Nueva Reserva</h4>

      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} small">{{ message }}</div>
        {% endfor %}
      {% endif %}

      <form id="reservation-form" method="post" novalidate>
        {% csrf_token %}

        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label">Nombre</label>
            {{ form.client_first_name }}
          </div>
          <div class="col-md-4">
            <label class="form-label">Apellido</label>
            {{ form.client_last_name }}
          </div>
          <div class="col-md-4">
            <label class="form-label">Teléfono</label>
            {{ form.client_phone }}
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Abono realizado</label>
          {{ form.amount_deposited }}
          <div class="form-text">Abono mínimo sugerido: <span id="min-deposit-display">$ 0</span></div>
        </div>

        {{ items_formset.management_form }}
        <div id="items-forms-container" class="d-none">
          {% for f in items_formset.forms %}
            <div class="form-row">{{ f.as_p }}</div>
          {% endfor %}
        </div>

        <!-- TABLA DE PRODUCTOS SELECCIONADOS -->
        <div class="table-responsive mb-3">
          <table class="table table-sm align-middle" id="selected-products-table">
            <thead class="table-light small">
              <tr>
                <th style="width:60px;"></th>
                <th>Producto / Variante</th>
                <th class="text-center" style="width:110px">Cantidad</th>
                <th class="text-end" style="width:120px">Precio</th>
                <th class="text-end" style="width:120px">Subtotal</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <td colspan="4" class="text-end fw-bold">Total:</td>
                <td class="text-end fw-bold" id="total-display">$ 0</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>

        <p id="due-message" class="small text-muted mb-3">Seleccione productos para calcular vencimiento.</p>

        <div class="d-flex gap-2">
          <button class="btn btn-primary">Guardar Reserva</button>
          <a href="{% url 'backoffice:billing:reservation_list' %}" class="btn btn-outline-secondary">Cancelar</a>
        </div>
      </form>
    </div>
  </div>

  <!-- PANEL DE PRODUCTOS -->
  <div class="card shadow-sm">
    <div class="card-header bg-light d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
      <!-- Buscador -->
      <div class="input-group input-group-sm" style="max-width: 320px;">
        <input id="product-search" type="text" class="form-control" placeholder="Buscar por nombre o SKU">
        <button class="btn btn-outline-secondary" type="button" id="clear-search">✕</button>
      </div>
      <!-- Filtro por variantes -->
      <div>
        <select id="variant-filter" class="form-select form-select-sm" style="width:200px;">
          <option value="all" selected>Todos</option>
          <option value="with">Con variantes</option>
          <option value="without">Sin variantes</option>
        </select>
      </div>
    </div>
    <div class="card-body" style="max-height: 500px; overflow-y: auto;">
      <div id="products-container" class="row g-3">
        {# JS renderiza tarjetas aquí #}
      </div>
      <div id="pagination-container" class="mt-3"></div>
    </div>
  </div>

  <textarea id="empty-item-template" style="display:none;">{{ items_formset.empty_form.as_p|escape }}</textarea>
</div>
{% endblock %}

{% block extra_js %}
<script>
  window.RESERVATION_CONFIG = {
    productsApiUrl: "{{ products_api_url|default:'/billing/products/json/' }}",
    prefix: "items"
  };
</script>
<script src="{% static 'js/reservation_create.js' %}"></script>
{% endblock %}

{% extends "backoffice/base_backoffice.html" %}
{% load static %}
{% load breadcrumbs %}
{% load money %}

{% block title %}Actualizar Reserva #{{ reservation.id }}{% endblock %}

{% block breadcrumb %}
  {% breadcrumb "Reservas|backoffice:billing:reservation_list" "Actualizar Reserva" %}
{% endblock %}

{% block content %}
<div id="reservation-page" class="container-fluid py-4">

  <!-- Encabezado -->
<div class="card mb-4">
  <div class="card-header">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-0">
          <i class="bi bi-pencil me-2"></i>Actualizar Reserva #{{ reservation.id }}
        </h5>
        <small class="text-muted">Modifique los datos de la reserva existente</small>
      </div>
      <div class="d-flex gap-2">
        <a href="{% url 'backoffice:billing:reservation_list' %}"
           class="btn btn-outline-secondary"
           data-bs-toggle="tooltip"
           title="Volver a la lista">
            <i class="bi bi-arrow-left me-1"></i>Volver
        </a>
        <a href="{% url 'backoffice:billing:reservation_detail' reservation.pk %}"
           class="btn btn-outline-primary">
            <i class="bi bi-eye me-1"></i>Ver detalle
        </a>
      </div>
    </div>
  </div>
</div>


  <!-- Formulario de actualización -->
  <form id="reservation-form" method="post" novalidate>
    {% csrf_token %}

    <!-- Datos del cliente -->
    <div class="card mb-4">
      <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-person me-1"></i>Datos del Cliente</h6>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label for="id_client_first_name" class="form-label">Nombre</label>
            {{ form.client_first_name }}
            {% if form.client_first_name.errors %}
              <div class="invalid-feedback d-block">{{ form.client_first_name.errors.0 }}</div>
            {% endif %}
          </div>
          <div class="col-md-4">
            <label for="id_client_last_name" class="form-label">Apellido</label>
            {{ form.client_last_name }}
            {% if form.client_last_name.errors %}
              <div class="invalid-feedback d-block">{{ form.client_last_name.errors.0 }}</div>
            {% endif %}
          </div>
          <div class="col-md-4">
            <label for="id_client_phone" class="form-label">Teléfono</label>
            {{ form.client_phone }}
            {% if form.client_phone.errors %}
              <div class="invalid-feedback d-block">{{ form.client_phone.errors.0 }}</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Información de abono y fechas -->
    <div class="card mb-4">
      <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-cash-coin me-1"></i>Información de Pago y Fechas</h6>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label for="id_amount_deposited" class="form-label">Abono realizado</label>
            {{ form.amount_deposited }}
            <div class="form-text">
              <i class="bi bi-info-circle me-1"></i>
              Mínimo requerido (20%): <span id="min-deposit-display" class="fw-semibold">$ 0</span>
            </div>
            {% if form.amount_deposited.errors %}
              <div class="invalid-feedback d-block">{{ form.amount_deposited.errors.0 }}</div>
            {% endif %}
          </div>
          <div class="col-md-4">
            <label class="form-label">Fecha de creación</label>
            <input type="text" class="form-control" value="{{ reservation.created_at|date:'d/m/Y H:i' }}" disabled>
            <div class="form-text">No se puede modificar</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Fecha de vencimiento</label>
            <input type="text" class="form-control" value="{{ reservation.due_date|date:'d/m/Y H:i' }}" disabled>
            <div class="form-text">Se calcula automáticamente</div>
          </div>
        </div>

        <!-- Mensaje de validez -->
        <div class="alert alert-info mt-3" role="alert">
          <i class="bi bi-clock me-1"></i>
          <span id="due-message">Calculando período de validez...</span>
        </div>
      </div>
    </div>

    <!-- Productos de la reserva -->
    <div class="card mb-4">
      <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-box-seam me-1"></i>Productos Reservados</h6>
      </div>
      <div class="card-body">
        <!-- Formset oculto -->
        <div id="items-forms-container" class="d-none">
          {{ items_formset.management_form }}
          {% for form in items_formset %}
            {{ form.product }}
            {{ form.variant }}
            {{ form.quantity }}
            {{ form.unit_price }}
          {% endfor %}
        </div>

        <div class="table-responsive">
          <table id="selected-products-table" class="table table-striped align-middle">
            <thead>
              <tr>
                <th style="width:60px;">#</th>
                <th>Producto / Variante</th>
                <th class="text-center" style="width:100px;">Cantidad</th>
                <th class="text-end" style="width:120px;">Precio Unitario</th>
                <th class="text-end" style="width:120px;">Subtotal</th>
              </tr>
            </thead>
            <tbody>
              {% for item in reservation.items.all %}
                <tr>
                  <td class="text-center">
                    <span class="badge bg-secondary">{{ forloop.counter }}</span>
                  </td>
                  <td>
                    <div class="fw-semibold">{{ item.product.name }}</div>
                    {% if item.variant %}
                      <div class="text-muted small">
                        {% if item.variant.size %}Talla: {{ item.variant.size }}{% endif %}
                        {% if item.variant.color %}
                          {% if item.variant.size %} - {% endif %}
                          Color: {{ item.variant.color }}
                        {% endif %}
                      </div>
                      <small class="text-muted text-mono">SKU Variante: {{ item.variant.sku }}</small>
                    {% else %}
                      <small class="text-muted text-mono">SKU Producto: {{ item.product.sku }}</small>
                    {% endif %}
                  </td>
                  <td class="text-center">
                    <span class="badge bg-primary">{{ item.quantity }}</span>
                  </td>
                  <td class="text-end fw-semibold">{{ item.unit_price|cop }}</td>
                  <td class="text-end fw-semibold">{{ item.subtotal|cop }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="5" class="text-center text-muted py-4">
                    <i class="bi bi-inbox display-6 d-block mb-2 text-muted"></i>
                    No hay productos en esta reserva
                  </td>
                </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <th colspan="4" class="text-end">Total de la reserva:</th>
                <th class="text-end" id="total-display">{{ reservation.total|cop }}</th>
              </tr>
            </tfoot>
          </table>
        </div>

        <div class="alert alert-warning mt-3" role="alert">
          <i class="bi bi-exclamation-triangle me-1"></i>
          <strong>Nota:</strong> Los productos no se pueden modificar desde aquí. Para cambiar los productos, debe crear una nueva reserva.
        </div>
      </div>
    </div>

    <!-- Botones de acción -->
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-1">Resumen de cambios</h6>
            <small class="text-muted">Solo se pueden modificar los datos del cliente y el abono</small>
          </div>
          <div class="d-flex gap-2">
            <a href="{% url 'backoffice:billing:reservation_list' %}" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left me-1"></i>Cancelar
            </a>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-save me-1"></i>Guardar Cambios
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<script src="{% static 'js/reservation_update.js' %}"></script>
{% endblock %}
{% extends "backoffice/base_backoffice.html" %}
{% load breadcrumbs %}
{% load money %}

{% block title %}Facturas - Facturación{% endblock %}

{% block breadcrumb %}
  {% breadcrumb "Facturas" %}
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Encabezado -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1">Facturas</h1>
      <p class="text-muted mb-0">Gestión de facturas registradas en el sistema</p>
    </div>
    <div class="d-flex gap-2">
      {% if perms.billing.add_invoice %}
      <a href="{% url 'backoffice:billing:sale_create' %}" class="btn btn-success">
        <i class="bi bi-plus-circle me-1"></i>Nueva Venta
      </a>
      {% endif %}
    </div>
  </div>

  <!-- Estadísticas rápidas -->
  <div class="row g-3 mb-4">
    <div class="col-md">
      <div class="card stats-card border-left-primary">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h5 class="card-title text-primary mb-1">{{ stats.total_facturas }}</h5>
            <p class="card-text text-muted small mb-0">Total facturas</p>
          </div>
          <div class="stats-icon text-primary"><i class="bi bi-receipt"></i></div>
        </div>
      </div>
    </div>
    <div class="col-md">
      <div class="card stats-card border-left-success">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h5 class="card-title text-success mb-1">{{ stats.total_vendido|cop }}</h5>
            <p class="card-text text-muted small mb-0">Total vendido</p>
          </div>
          <div class="stats-icon text-success"><i class="bi bi-currency-dollar"></i></div>
        </div>
      </div>
    </div>
    <div class="col-md">
      <div class="card stats-card border-left-info">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h5 class="card-title text-info mb-1">{{ stats.efectivo }}</h5>
            <p class="card-text text-muted small mb-0">En efectivo</p>
          </div>
          <div class="stats-icon text-info"><i class="bi bi-cash"></i></div>
        </div>
      </div>
    </div>
    <div class="col-md">
      <div class="card stats-card border-left-warning">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h5 class="card-title text-warning mb-1">{{ stats.digital }}</h5>
            <p class="card-text text-muted small mb-0">En digital</p>
          </div>
          <div class="stats-icon text-warning"><i class="bi bi-phone"></i></div>
        </div>
      </div>
    </div>
    <div class="col-md">
      <div class="card stats-card border-left-secondary">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-title text-secondary fw-semibold mb-1">
              Nequi: {{ stats.nequi }} | Daviplata: {{ stats.daviplata }}
            </h6>
            <p class="card-text text-muted small mb-0">Detalle digital</p>
          </div>
          <div class="stats-icon text-secondary"><i class="bi bi-wallet2"></i></div>
        </div>
      </div>
    </div>
  </div>

<!-- 🔍 Filtros -->
<div class="card mb-4 shadow-sm">
  <div class="card-header bg-light">
    <h6 class="mb-0"><i class="bi bi-funnel me-1"></i>Filtros de búsqueda</h6>
  </div>
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label small fw-semibold">Cliente o código</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input type="text" name="q" value="{{ current_q }}" class="form-control"
                 placeholder="Juan Pérez, FAC-2025...">
        </div>
      </div>
      <div class="col-md-2">
        <label class="form-label small fw-semibold">Método de pago</label>
        <select name="payment_method" class="form-select">
          <option value="">Todos</option>
          <option value="EF" {% if current_payment_method == "EF" %}selected{% endif %}>Efectivo</option>
          <option value="DI" {% if current_payment_method == "DI" %}selected{% endif %}>Digital</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label small fw-semibold">Proveedor digital</label>
        <select name="payment_provider" class="form-select">
          <option value="">Todos</option>
          <option value="NEQUI" {% if current_payment_provider == "NEQUI" %}selected{% endif %}>Nequi</option>
          <option value="DAVIPLATA" {% if current_payment_provider == "DAVIPLATA" %}selected{% endif %}>Daviplata</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label small fw-semibold">Desde</label>
        <input type="date" name="date_from" value="{{ current_date_from }}" class="form-control">
      </div>
      <div class="col-md-2">
        <label class="form-label small fw-semibold">Hasta</label>
        <input type="date" name="date_to" value="{{ current_date_to }}" class="form-control">
      </div>
      <!-- Botones alineados en la misma fila -->
      <div class="col-md-auto d-flex gap-2">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-search"></i>
        </button>
        <a href="{% url 'backoffice:billing:invoice_list' %}" class="btn btn-outline-secondary">
          <i class="bi bi-x-circle"></i>
        </a>
      </div>
    </form>
  </div>
</div>


  <!-- Tabla de facturas -->
  <div class="card shadow-sm">
    <div class="card-header">
      <h6 class="mb-0"><i class="bi bi-table me-2"></i>Listado de Facturas</h6>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead>
          <tr>
            <th>Código</th>
            <th>Cliente</th>
            <th>Total</th>
            <th>Estado</th>
            <th>Método</th>
            <th>Fecha</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for invoice in invoices %}
          <tr>
            <td><span class="fw-semibold text-primary">{{ invoice.code }}</span></td>
            <td>
              <div class="fw-medium">{{ invoice.client_first_name }} {{ invoice.client_last_name }}</div>
              {% if invoice.client_phone %}
              <small class="text-muted">{{ invoice.client_phone }}</small>
              {% endif %}
            </td>
            <td><span class="fw-bold">{{ invoice.total|cop }}</span></td>
            <td>
              {% if invoice.status == "completed" %}
                <span class="badge bg-success">Completada</span>
              {% elif invoice.status == "pending" %}
                <span class="badge bg-warning text-dark">Pendiente</span>
              {% elif invoice.status == "cancelled" %}
                <span class="badge bg-danger">Cancelada</span>
              {% endif %}
            </td>
            <td>
              {% if invoice.payment_method == "EF" %}
                <span class="badge bg-success"><i class="bi bi-cash me-1"></i>Efectivo</span>
              {% elif invoice.payment_method == "DI" %}
                {% if invoice.payment_provider == "NEQUI" %}
                  <span class="badge bg-info"><i class="bi bi-phone me-1"></i>Nequi</span>
                {% elif invoice.payment_provider == "DAVIPLATA" %}
                  <span class="badge bg-warning text-dark"><i class="bi bi-phone me-1"></i>Daviplata</span>
                {% else %}
                  <span class="badge bg-info"><i class="bi bi-phone me-1"></i>Digital</span>
                {% endif %}
              {% else %}
                <span class="badge bg-secondary">N/A</span>
              {% endif %}
            </td>
            <td>
              <div>{{ invoice.created_at|date:"d/m/Y" }}</div>
              <small class="text-muted">{{ invoice.created_at|date:"H:i" }}</small>
            </td>
            <td class="text-end">
              <div class="d-flex justify-content-end">
                <a href="{% url 'backoffice:billing:invoice_detail' invoice.pk %}"
                   class="btn btn-sm btn-outline-primary me-1" title="Ver detalle">
                  <i class="bi bi-eye"></i>
                </a>
                <a href="{% url 'backoffice:billing:invoice_html' invoice.pk %}"
                   target="_blank" class="btn btn-sm btn-outline-secondary" title="Imprimir">
                  <i class="bi bi-printer"></i>
                </a>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center text-muted py-4">
              <i class="bi bi-inbox display-6 d-block mb-2"></i>
              No hay facturas registradas con los filtros aplicados.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

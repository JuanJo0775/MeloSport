{% extends "backoffice/billing/invoice_template/invoice_base.html" %}
{% load static %}
{% load money %}
{% load extra_filters %}

{% block title %}Factura {{ invoice.code }}{% endblock %}

{% block header_right %}
  <div class="text-end">
    <img src="{% static 'img/Logo sin fondo azul.png' %}" alt="Logo" style="height:45px;" class="mb-2">
    <h6 class="mb-0 text-primary fw-bold">FACTURA</h6>
    <div class="fw-semibold"># {{ invoice.code }}</div>
    <small class="text-muted">{{ invoice.created_at|date:"d/m/Y H:i" }}</small>
  </div>
{% endblock %}

{% block content %}
<div class="ticket-border p-3">

  <!-- Cliente -->
  <section class="mb-3 pb-2 border-bottom border-dashed">
    <div class="d-flex justify-content-between">
      <div>
        <div class="fw-semibold">{{ invoice.client_first_name }} {{ invoice.client_last_name }}</div>
        {% if invoice.client_phone %}
          <small class="text-muted"><i class="bi bi-telephone me-1"></i>{{ invoice.client_phone }}</small>
        {% endif %}
      </div>
      <div class="text-end">
        <small class="text-muted">Facturación:</small><br>
        <span class="fw-medium">{{ invoice.created_at|date:"d/m/Y" }}</span><br>
        <small class="text-muted">{{ invoice.created_at|date:"H:i" }}</small>
      </div>
    </div>
  </section>

  <!-- Productos -->
  <div class="table-responsive mb-3">
    <table class="table table-sm mb-0 border border-dashed">
      <thead class="table-light border-bottom border-dashed">
        <tr>
          <th>Producto</th>
          <th class="text-center">Cant.</th>
          <th class="text-end">Unit.</th>
          <th class="text-end">Subtotal</th>
        </tr>
      </thead>
      <tbody>
        {% for item in invoice.items.all %}
        <tr class="border-bottom border-dashed">
          <td>
            <div class="fw-medium">{{ item.product.name }}</div>
            {% if item.variant %}
              <small class="text-muted">
                {% if item.variant.label %}{{ item.variant.label }}{% endif %}
                {% if item.variant.size %} • Talla: {{ item.variant.size }}{% endif %}
                {% if item.variant.color %} • Color: {{ item.variant.color }}{% endif %}
              </small>
              {% if item.variant.sku %}
                <div class="small text-muted text-mono">SKU: {{ item.variant.sku }}</div>
              {% endif %}
            {% else %}
              {% if item.product.sku %}
                <div class="small text-muted text-mono">SKU: {{ item.product.sku }}</div>
              {% endif %}
            {% endif %}
          </td>
          <td class="text-center">{{ item.quantity }}</td>
          <td class="text-end">{{ item.unit_price|cop }}</td>
          <td class="text-end fw-semibold">{{ item.subtotal|cop }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" class="text-center text-muted py-3">No hay productos.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Totales -->
  <div class="pt-2 border-top border-dashed">
    <table class="table table-sm table-borderless mb-0">
      <tbody>
        <tr>
          <td><i class="bi bi-receipt me-1"></i>Subtotal:</td>
          <td class="text-end">{{ subtotal|cop }}</td>
        </tr>
        {% if discount > 0 %}
        <tr>
          <td><i class="bi bi-percent me-1 text-danger"></i>Descuento:</td>
          <td class="text-end text-danger">- {{ discount|cop }}</td>
        </tr>
        {% endif %}
        <tr class="border-top border-dashed">
          <td class="fw-bold">TOTAL:</td>
          <td class="text-end fw-bold text-primary">{{ total|cop }}</td>
        </tr>
        {% if reservation_info and reservation_info.abonado > 0 %}
        <tr>
          <td><i class="bi bi-wallet2 me-1 text-info"></i>Abono reserva:</td>
          <td class="text-end text-info">+ {{ reservation_info.abonado|cop }}</td>
        </tr>
        {% endif %}
        <tr>
          <td class="fw-medium text-success">
            <i class="bi bi-check-circle-fill me-1"></i>Pagado:
          </td>
          <td class="text-end text-success fw-semibold">{{ amount_paid|cop }}</td>
        </tr>
        {% if balance_due > 0 %}
        <tr>
          <td class="fw-medium text-warning">
            <i class="bi bi-exclamation-triangle-fill me-1"></i>Saldo pendiente:
          </td>
          <td class="text-end text-warning">{{ balance_due|cop }}</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Pago -->
  <section class="mt-3 border-top border-dashed pt-2">
    <small>
      <strong>Método de pago:</strong>
      {% if invoice.payment_method == "EF" %}
        <i class="bi bi-cash-coin text-success ms-1"></i> Efectivo
      {% elif invoice.payment_method == "DI" %}
        <i class="bi bi-phone text-primary ms-1"></i>
        {% if invoice.payment_provider == "NEQUI" %}Nequi{% elif invoice.payment_provider == "DAVIPLATA" %}Daviplata{% else %}Digital{% endif %}
      {% endif %}
      {% if invoice.payment_date %}
        • <i class="bi bi-calendar-check me-1"></i>{{ invoice.payment_date|date:"d/m/Y H:i" }}
      {% endif %}
    </small>
  </section>

  <!-- Footer tipo ticket -->
  {% if not digital_only %}
  <div class="text-center mt-3 border-top border-dashed pt-2">
    <div class="mb-2 text-muted">
      <i class="bi bi-scissors me-1"></i><small> Cortar por aquí</small>
    </div>
  </div>
  {% endif %}

  <div class="text-center mt-2">
    <div><strong class="text-primary">¡Gracias por su compra!</strong></div>
    <small class="text-muted">Conserve esta factura como comprobante</small>
  </div>
</div>
{% endblock %}

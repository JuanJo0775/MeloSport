{% extends "backoffice/base_backoffice.html" %}
{% load breadcrumbs %}

{% block title %}Gestionar Inventario — Productos{% endblock %}

{% block breadcrumb %}
  {% breadcrumb "Inventario|backoffice:products:inventory:index" "Productos" %}
{% endblock %}

{% block content %}
<div class="container">
  <h1 class="mb-4">Inventario — Seleccione Productos</h1>

  <!-- Buscador -->
  <form method="get" class="row g-2 mb-3">
    <div class="col-md-4">
      <input class="form-control" name="q" value="{{ query }}" placeholder="Buscar producto por nombre...">
    </div>
    <div class="col-md-2">
      <button class="btn btn-primary">Buscar</button>
    </div>
  </form>

  <!-- Acciones masivas -->
  <form method="post" action="{% url 'backoffice:products:inventory:bulk_add_products' %}" id="bulk-products-form">
    {% csrf_token %}
    <div class="mb-2 d-flex gap-2 align-items-center">
      <select id="bulk-action" class="form-select w-auto" name="movement_type">
        <option value="in">Añadir stock (entrada)</option>
        <option value="adjust">Ajuste</option>
      </select>
      <input type="number" name="quantity" id="bulk-quantity" class="form-control w-auto" placeholder="Cantidad" min="1">
      <button type="submit" class="btn btn-success">Aplicar a seleccionados</button>
      <a href="{% url 'backoffice:products:inventory:inventory_create' %}" class="btn btn-secondary ms-auto">
        Nuevo Movimiento
      </a>
    </div>

    <input type="hidden" name="product_ids" id="product-ids-field" value="">

    <!-- Tabla -->
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th><input type="checkbox" id="select-all"></th>
          <th>Nombre</th>
          <th>SKU</th>
          <th>Stock</th>
          <th>Variantes</th>
          <th class="text-end">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for p in products %}
        <tr>
          <td>
            {% if p.variants.exists %}
              <!-- Producto con variantes: no se permite en acción masiva -->
              <input type="checkbox" disabled title="Producto con variantes: gestionar desde Variantes">
            {% else %}
              <input type="checkbox" class="product-checkbox" value="{{ p.id }}">
            {% endif %}
          </td>
          <td>{{ p.name }}</td>
          <td>{{ p.sku|default:"—" }}</td>
          <td>{{ p.stock }}</td>
          <td>
            {% if p.variants.exists %}
              <a href="{% url 'backoffice:products:inventory:product_variants' p.id %}"
                 class="btn btn-sm btn-outline-info">
                Variantes
              </a>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </td>
          <td class="text-end">
            {% if p.variants.exists %}
              <a href="{% url 'backoffice:products:inventory:product_variants' p.id %}"
                 class="btn btn-sm btn-primary">
                <i class="bi bi-layers me-1"></i> Gestionar
              </a>
            {% else %}
              <a href="{% url 'backoffice:products:inventory:inventory_create' %}?product={{ p.id }}"
                 class="btn btn-sm btn-success">
                <i class="bi bi-plus-circle me-1"></i> Agregar Stock
              </a>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="6" class="text-center text-muted">No hay productos.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </form>
</div>

<!-- JS para manejar selección masiva -->
<script>
document.getElementById("select-all").addEventListener("change", function(e){
  const checked = e.target.checked;
  document.querySelectorAll(".product-checkbox").forEach(ch => ch.checked = checked);
  updateHiddenIds();
});
document.querySelectorAll(".product-checkbox").forEach(cb=>{
  cb.addEventListener("change", updateHiddenIds);
});
function updateHiddenIds(){
  const ids = Array.from(document.querySelectorAll(".product-checkbox:checked")).map(i=>i.value);
  document.getElementById("product-ids-field").value = ids.join(",");
}
document.getElementById("bulk-products-form").addEventListener("submit", function(e){
  const ids = document.getElementById("product-ids-field").value;
  const qty = document.getElementById("bulk-quantity").value;
  if(!ids){
    e.preventDefault(); alert("Seleccione al menos un producto válido para acción masiva.");
    return;
  }
  if(!qty || Number(qty) <= 0){
    e.preventDefault(); alert("Ingrese una cantidad válida.");
    return;
  }
});
</script>
{% endblock %}

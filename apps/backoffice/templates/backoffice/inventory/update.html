{% extends "backoffice/base_backoffice.html" %}
{% load breadcrumbs %}

{% block title %}Editar Movimiento{% endblock %}

{% block breadcrumb %}
  {% breadcrumb "Inventario|backoffice:products:inventory:index" "Movimientos|backoffice:products:inventory:inventory_list" "Editar Movimiento" %}
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Encabezado -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1">Editar Movimiento #{{ object.id }}</h1>
      <p class="text-muted mb-0">Modifica los datos del movimiento de inventario</p>
    </div>
    <a href="{% url 'backoffice:products:inventory:inventory_list' %}"
       class="btn btn-outline-secondary"
       data-bs-toggle="tooltip"
       title="Volver a la lista">
      <i class="bi bi-arrow-left me-1"></i>Volver
    </a>
  </div>

  <!-- Información del movimiento actual -->
  <div class="card mb-4">
    <div class="card-header">
      <h6 class="card-title mb-0"><i class="bi bi-info-circle me-2"></i>Información Actual</h6>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3">
          <strong>Producto:</strong>
          <div class="text-muted">{{ object.product.name }}</div>
        </div>
        <div class="col-md-3">
          <strong>Tipo:</strong>
          <div class="text-muted">
            {% if object.movement_type == 'in' %}
              <span class="badge bg-success">{{ object.get_movement_type_display }}</span>
            {% elif object.movement_type == 'out' %}
              <span class="badge bg-danger">{{ object.get_movement_type_display }}</span>
            {% else %}
              <span class="badge bg-warning text-dark">{{ object.get_movement_type_display }}</span>
            {% endif %}
          </div>
        </div>
        <div class="col-md-3">
          <strong>Cantidad:</strong>
          <div class="text-muted fw-semibold">{{ object.quantity }}</div>
        </div>
        <div class="col-md-3">
          <strong>Fecha:</strong>
          <div class="text-muted">{{ object.created_at|date:"Y-m-d H:i" }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulario de edición -->
<div class="card">
  <div class="card-header">
    <h6 class="card-title mb-0"><i class="bi bi-pencil me-2"></i>Editar Datos</h6>
  </div>
  <div class="card-body">
    {% if form.errors %}
    <div class="alert alert-danger mb-4">
      <h6 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Errores en el formulario</h6>
      <ul class="mb-0">
        {% for field, errors in form.errors.items %}
          <li><strong>{{ field|capfirst }}:</strong> {{ errors|join:", " }}</li>
        {% endfor %}
        {% for error in form.non_field_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    <form method="post" class="needs-validation" novalidate>
      {% csrf_token %}

      <div class="row g-4">
        <!-- Producto -->
        <div class="col-md-6">
          <label for="{{ form.product.id_for_label }}" class="form-label fw-semibold">
            Producto <span class="text-danger">*</span>
          </label>
          {% if form.product_display %}
            {{ form.product_display }}
            {{ form.product }}
          {% else %}
            {{ form.product }}
          {% endif %}
          {% if form.product.help_text %}
            <div class="form-text">{{ form.product.help_text }}</div>
          {% endif %}
          {% if form.product.errors %}
            <div class="invalid-feedback d-block">{{ form.product.errors|join:", " }}</div>
          {% endif %}
        </div>

        <!-- Variante -->
        {% if form.variant %}
        <div class="col-md-6">
          <label for="{{ form.variant.id_for_label }}" class="form-label fw-semibold">
            Variante
          </label>
          {{ form.variant }}
          {% if form.variant.help_text %}
            <div class="form-text">{{ form.variant.help_text }}</div>
          {% endif %}
          {% if form.variant.errors %}
            <div class="invalid-feedback d-block">{{ form.variant.errors|join:", " }}</div>
          {% endif %}
        </div>
        {% endif %}

        <!-- Tipo de movimiento -->
        <div class="col-md-4">
          <label for="{{ form.movement_type.id_for_label }}" class="form-label fw-semibold">
            Tipo de Movimiento <span class="text-danger">*</span>
          </label>
          {{ form.movement_type }}
          {% if form.movement_type.help_text %}
            <div class="form-text">{{ form.movement_type.help_text }}</div>
          {% endif %}
          {% if form.movement_type.errors %}
            <div class="invalid-feedback d-block">{{ form.movement_type.errors|join:", " }}</div>
          {% endif %}
        </div>

        <!-- Acción (añadir/quitar) - visible solo en ajustes -->
        <div class="col-md-8 {% if object.movement_type != 'adjust' %}d-none{% endif %}" id="adjust-action-wrapper">
          <label class="form-label fw-semibold d-block">{{ form.action.label }}</label>
          <div class="d-flex gap-3">
            <div>
              <input type="radio" class="btn-check" name="action" id="action_add" value="add"
                     {% if form.initial.action == "add" or form.action.value == "add" %}checked{% endif %}>
              <label class="btn btn-outline-success fw-semibold px-4 py-2" for="action_add">
                <i class="bi bi-plus-circle me-1"></i> Añadir stock
              </label>
            </div>
            <div>
              <input type="radio" class="btn-check" name="action" id="action_remove" value="remove"
                     {% if form.initial.action == "remove" or form.action.value == "remove" %}checked{% endif %}>
              <label class="btn btn-outline-danger fw-semibold px-4 py-2" for="action_remove">
                <i class="bi bi-dash-circle me-1"></i> Quitar stock
              </label>
            </div>
          </div>
          {% if form.action.help_text %}
            <div class="form-text mt-1">{{ form.action.help_text }}</div>
          {% endif %}
        </div>

        <!-- Motivo del ajuste -->
        <div class="col-12 {% if object.movement_type != 'adjust' %}d-none{% endif %}" id="adjust-reason-wrapper">
          <label for="{{ form.adjust_reason.id_for_label }}" class="form-label fw-semibold">
            Motivo del ajuste <span class="text-danger">*</span>
          </label>
          {{ form.adjust_reason }}
          {% if form.adjust_reason.help_text %}
            <div class="form-text">{{ form.adjust_reason.help_text }}</div>
          {% endif %}
          {% if form.adjust_reason.errors %}
            <div class="invalid-feedback d-block">{{ form.adjust_reason.errors|join:", " }}</div>
          {% endif %}
        </div>

        <!-- Cantidad -->
        <div class="col-md-4">
          <label for="{{ form.quantity.id_for_label }}" class="form-label fw-semibold">
            Cantidad <span class="text-danger">*</span>
          </label>
          {{ form.quantity }}
          <small id="qty-warning" class="text-danger d-none"></small>
          {% if form.quantity.help_text %}
            <div class="form-text">{{ form.quantity.help_text }}</div>
          {% endif %}
          {% if form.quantity.errors %}
            <div class="invalid-feedback d-block">{{ form.quantity.errors|join:", " }}</div>
          {% endif %}
        </div>

        <!-- Precio unitario -->
        {% if form.unit_price %}
        <div class="col-md-4">
          <label for="{{ form.unit_price.id_for_label }}" class="form-label fw-semibold">Precio Unitario</label>
          <div class="input-group">
            <span class="input-group-text">$</span>
            {{ form.unit_price }}
          </div>
          {% if form.unit_price.help_text %}
            <div class="form-text">{{ form.unit_price.help_text }}</div>
          {% endif %}
          {% if form.unit_price.errors %}
            <div class="invalid-feedback d-block">{{ form.unit_price.errors|join:", " }}</div>
          {% endif %}
        </div>
        {% endif %}

        <!-- Notas -->
        <div class="col-12">
          <label for="{{ form.notes.id_for_label }}" class="form-label fw-semibold">Notas</label>
          {{ form.notes }}
          {% if form.notes.help_text %}
            <div class="form-text">{{ form.notes.help_text }}</div>
          {% endif %}
          {% if form.notes.errors %}
            <div class="invalid-feedback d-block">{{ form.notes.errors|join:", " }}</div>
          {% endif %}
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-muted small">
              <i class="bi bi-info-circle me-1"></i>
              Los campos marcados con <span class="text-danger">*</span> son obligatorios
            </span>
            <div class="d-flex gap-2">
              <a href="{% url 'backoffice:products:inventory:inventory_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle me-1"></i>Cancelar
              </a>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-circle me-1"></i>Actualizar Movimiento
              </button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>


  <!-- Info adicional -->
  <div class="row mt-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h6 class="card-title mb-0"><i class="bi bi-clock-history me-2"></i>Historial</h6>
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-sm-5">Creado:</dt>
            <dd class="col-sm-7">{{ object.created_at|date:"Y-m-d H:i:s" }}</dd>
            <dt class="col-sm-5">Usuario:</dt>
            <dd class="col-sm-7">{{ object.user.get_full_name|default:object.user.username }}</dd>
            {% if object.updated_at and object.updated_at != object.created_at %}
            <dt class="col-sm-5">Modificado:</dt>
            <dd class="col-sm-7">{{ object.updated_at|date:"Y-m-d H:i:s" }}</dd>
            {% endif %}
          </dl>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h6 class="card-title mb-0"><i class="bi bi-calculator me-2"></i>Cálculos</h6>
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            {% if object.unit_price %}
            <dt class="col-sm-6">Precio unitario:</dt>
            <dd class="col-sm-6">{{ object.unit_price|floatformat:0 }}</dd>
            <dt class="col-sm-6">Cantidad:</dt>
            <dd class="col-sm-6">{{ object.quantity }}</dd>
            <dt class="col-sm-6">Total:</dt>
            <dd class="col-sm-6 fw-semibold">{{ object.total|floatformat:0 }}</dd>
            {% else %}
            <dt class="col-sm-6">Cantidad:</dt>
            <dd class="col-sm-6 fw-semibold">{{ object.quantity }}</dd>
            <dt class="col-sm-6">Precio:</dt>
            <dd class="col-sm-6 text-muted">No especificado</dd>
            {% endif %}
          </dl>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  // Validación básica
  const form = document.querySelector('.needs-validation');
  if (form) {
    form.addEventListener('submit', function(event) {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    });
  }

  // Normalizar cantidad negativa
  const quantityInput = document.querySelector('input[name="quantity"]');
  const qtyWarning = document.getElementById('qty-warning');

  if (quantityInput) {
    quantityInput.addEventListener('input', function(e) {
      const value = parseInt(e.target.value);
      if (value < 0) {
        e.target.value = Math.abs(value);
      }

      const mtype = e.target.dataset.mtype;
      const oldQty = parseInt(e.target.dataset.old || "0", 10);
      const available = parseInt(e.target.dataset.available || "0", 10);

      if (mtype === "out") {
        const maxAllowed = oldQty + available;
        if (value > maxAllowed) {
          qtyWarning.textContent = `No hay suficiente stock. Máximo permitido: ${maxAllowed}.`;
          qtyWarning.classList.remove('d-none');
          e.target.classList.add('is-invalid');
        } else {
          qtyWarning.textContent = "";
          qtyWarning.classList.add('d-none');
          e.target.classList.remove('is-invalid');
        }
      } else {
        qtyWarning.textContent = "";
        qtyWarning.classList.add('d-none');
        e.target.classList.remove('is-invalid');
      }
    });
  }

  // Formatear precio
  const priceInput = document.querySelector('input[name="unit_price"]');
  if (priceInput) {
    priceInput.addEventListener('blur', function(e) {
      const value = parseFloat(e.target.value);
      if (!isNaN(value)) {
        e.target.value = value.toFixed(2);
      }
    });
  }
})();

(function(){
  const movementSelect = document.querySelector('select[name="movement_type"]');
  const actionWrapper = document.getElementById('adjust-action-wrapper');
  const reasonWrapper = document.getElementById('adjust-reason-wrapper');
  const radioAdd = document.getElementById('action_add');
  const radioRemove = document.getElementById('action_remove');
  const labelAdd = document.querySelector('label[for="action_add"]');
  const labelRemove = document.querySelector('label[for="action_remove"]');

  function isAdjustMode() {
    if (movementSelect) return movementSelect.value === 'adjust';
    // si no existe select (oculto), inferimos por radios
    return (radioAdd && radioAdd.checked) || (radioRemove && radioRemove.checked);
  }

  function toggleAdjustUI() {
    if (isAdjustMode()) {
      if (actionWrapper) actionWrapper.style.display = '';
      if (reasonWrapper) reasonWrapper.style.display = '';
    } else {
      if (actionWrapper) actionWrapper.style.display = 'none';
      if (reasonWrapper) reasonWrapper.style.display = 'none';
    }
  }

  function refreshActiveState() {
    if (labelAdd && labelRemove && radioAdd && radioRemove) {
      if (radioAdd.checked) {
        labelAdd.classList.add('active');
        labelRemove.classList.remove('active');
      } else if (radioRemove.checked) {
        labelRemove.classList.add('active');
        labelAdd.classList.remove('active');
      } else {
        labelAdd.classList.remove('active');
        labelRemove.classList.remove('active');
      }
    }
  }

  // eventos
  if (movementSelect) movementSelect.addEventListener('change', toggleAdjustUI);

  if (radioAdd) radioAdd.addEventListener('change', function(){ refreshActiveState(); toggleAdjustUI(); });
  if (radioRemove) radioRemove.addEventListener('change', function(){ refreshActiveState(); toggleAdjustUI(); });

  // init
  toggleAdjustUI();
  refreshActiveState();
})();
</script>
{% endblock %}

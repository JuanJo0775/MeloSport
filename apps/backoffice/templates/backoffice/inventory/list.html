{% extends "backoffice/base_backoffice.html" %}
{% load breadcrumbs %}
{% load money %}
{% load extra_filters %}

{% block title %}Movimientos de Inventario{% endblock %}

{% block breadcrumb %}
  {% breadcrumb "Inventario|backoffice:products:inventory:index" "Movimientos|backoffice:products:inventory:inventory_list" %}
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Encabezado -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <!-- Título -->
  <div>
    <h1 class="h3 mb-1">Movimientos de Inventario</h1>
    <p class="text-muted mb-0">Historial de entradas, salidas y ajustes de stock</p>
  </div>

  <!-- Botones de acción -->
  <div class="d-flex gap-2">
    <a href="{% url 'backoffice:products:inventory:index' %}"
       class="btn btn-outline-secondary"
       data-bs-toggle="tooltip"
       title="Volver a la lista">
      <i class="bi bi-arrow-left me-1"></i>Volver
    </a>
    {% if perms.products.add_inventorymovement %}
      <a href="{% url 'backoffice:products:inventory:products_inventory_list' %}" class="btn btn-success flex-fill">
        <i class="bi bi-eye me-2"></i>Ver Productos
      </a>
    {% endif %}
  </div>
</div>


  <!-- Estadísticas rápidas -->
    <div class="row g-3 mb-4">
      <!-- Total Movimientos -->
      <div class="col-md-3">
        <div class="card stats-card border-left-primary">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <h5 class="card-title text-primary mb-1">{{ movements.count }}</h5>
              <p class="card-text text-muted small mb-0">Total Movimientos</p>
            </div>
            <div class="stats-icon text-primary"><i class="bi bi-arrow-left-right"></i></div>
          </div>
        </div>
      </div>

      <!-- Entradas -->
      <div class="col-md-3">
        <div class="card stats-card border-left-success">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <h5 class="card-title text-success mb-1">{{ entries_count|default:0 }}</h5>
              <p class="card-text text-muted small mb-0">Entradas</p>
            </div>
            <div class="stats-icon text-success"><i class="bi bi-box-arrow-in-down"></i></div>
          </div>
        </div>
      </div>

      <!-- Salidas (inline rojo danger) -->
      <div class="col-md-3">
        <div class="card stats-card" style="border-left: 5px solid #dc3545;"> <!-- rojo danger -->
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <h5 class="card-title mb-1" style="color: #dc3545;">{{ exits_count|default:0 }}</h5>
              <p class="card-text text-muted small mb-0">Salidas</p>
            </div>
            <div class="stats-icon" style="color: #dc3545;"><i class="bi bi-box-arrow-up"></i></div>
          </div>
        </div>
      </div>

  <!-- Ajustes -->
  <div class="col-md-3">
    <div class="card stats-card border-left-warning">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <h5 class="card-title text-warning mb-1">{{ adjustments_count|default:0 }}</h5>
          <p class="card-text text-muted small mb-0">Ajustes</p>
        </div>
        <div class="stats-icon text-warning"><i class="bi bi-gear"></i></div>
      </div>
    </div>
  </div>
</div>

  <!-- Filtros -->
<div class="card mb-4">
  <div class="card-header">
    <h6 class="card-title mb-0">
      <i class="bi bi-funnel me-2"></i>Filtros de Búsqueda
    </h6>
  </div>
  <div class="card-body">
    <form method="get" class="row g-3 align-items-end">
      <div class="col-md-2">
        <label for="date_from" class="form-label">Desde</label>
        <input type="date" name="date_from" id="date_from"
               value="{{ filters.date_from }}" class="form-control">
      </div>

      <div class="col-md-2">
        <label for="date_to" class="form-label">Hasta</label>
        <input type="date" name="date_to" id="date_to"
               value="{{ filters.date_to }}" class="form-control">
      </div>

      <div class="col-md-2">
        <label for="type" class="form-label">Tipo</label>
        <select name="type" id="type" class="form-select">
          <option value="">-- Todos --</option>
          <option value="in" {% if filters.type == "in" %}selected{% endif %}>Entrada</option>
          <option value="out" {% if filters.type == "out" %}selected{% endif %}>Salida</option>
          <option value="adjust" {% if filters.type == "adjust" %}selected{% endif %}>Ajuste</option>
        </select>
      </div>

      <div class="col-md-2">
        <label for="user" class="form-label">Usuario</label>
        <input type="text" name="user" id="user"
               value="{{ filters.user }}" class="form-control"
               placeholder="Buscar por usuario...">
      </div>

      <div class="col-md-2">
        <label for="product" class="form-label">Producto</label>
        <input type="text" name="product" id="product"
               value="{{ filters.product }}" class="form-control"
               placeholder="Buscar por producto o SKU...">
      </div>

      <div class="col-md-2 d-flex gap-2">
        <button class="btn btn-primary flex-grow-1" type="submit">
          <i class="bi bi-search me-1"></i>Filtrar
        </button>
        <a href="{% url 'backoffice:products:inventory:inventory_list' %}"
           class="btn btn-outline-secondary flex-grow-1">
          <i class="bi bi-x-circle me-1"></i>Limpiar
        </a>
      </div>
    </form>
  </div>
</div>


    <!-- Tabla de movimientos -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-list-task me-2"></i>Listado de Movimientos</span>
        <small class="text-muted">{{ movements.count }} movimiento{{ movements.count|pluralize }}</small>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Producto</th>
                <th>Variante</th>
                <th>Tipo</th>
                <th class="text-center">Cantidad</th>
                <th class="text-end">Precio Unit.</th>
                <th class="text-end">Total</th>
                <th>Usuario</th>
                <th>Fecha</th>
                <th class="text-center">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for mov in movements %}
              <tr>
                <td class="text-mono">#{{ mov.id }}</td>
                <td>
                  <div class="fw-semibold">{{ mov.product.name }}</div>
                  {% if mov.product.sku %}
                    <small class="text-muted">SKU: {{ mov.product.sku }}</small>
                  {% endif %}
                </td>
                <td>
                  {% if mov.variant %}
                    <div>
                      {% if mov.variant.sku %}
                        <span class="badge bg-light text-dark">{{ mov.variant.sku }}</span>
                      {% endif %}
                      {% if mov.variant.size %}
                        <div><small class="text-muted">Talla: {{ mov.variant.size }}</small></div>
                      {% endif %}
                      {% if mov.variant.color %}
                        <div><small class="text-muted">Color: {{ mov.variant.color }}</small></div>
                      {% endif %}
                    </div>
                  {% else %}
                    <span class="text-muted">N/A</span>
                  {% endif %}
                </td>
                <td>
                  {% if mov.movement_type == 'in' %}
                    <span class="badge bg-success">{{ mov.get_movement_type_display }}</span>
                  {% elif mov.movement_type == 'out' %}
                    <span class="badge bg-danger">{{ mov.get_movement_type_display }}</span>
                  {% else %}
                    <span class="badge bg-warning text-dark">{{ mov.get_movement_type_display }}</span>
                  {% endif %}
                </td>
                    <td class="text-center fw-semibold">
                      {% if mov.movement_type == 'in' %}
                        <span class="text-success">+{{ mov.quantity }}</span>
                        <div><small class="text-muted">Entrada de stock</small></div>

                      {% elif mov.movement_type == 'out' %}
                        <span class="text-danger">-{{ mov.quantity }}</span>
                        <div><small class="text-muted">Salida de stock</small></div>

                      {% elif mov.movement_type == 'adjust' %}
                        {% if mov.quantity > 0 %}
                          <span class="text-success">+{{ mov.quantity }}</span>
                          <div><small class="text-muted">Se añadió stock</small></div>
                        {% else %}
                          <span class="text-danger">-{{ mov.quantity|cut:"-" }}</span>
                          <div><small class="text-muted">Se quitó stock</small></div>
                        {% endif %}
                      {% endif %}
                    </td>
                <td class="text-end">
                  {% if mov.final_unit_price %}
                    {{ mov.final_unit_price|absval|cop }}
                  {% else %}
                    {{ mov.product.price|absval|cop }}
                  {% endif %}
                </td>

                <td class="text-end fw-semibold">
                  {% if mov.total_amount %}
                    {{ mov.total_amount|absval|cop }}
                  {% else %}
                    {{ mov.product.price|mul:mov.quantity|absval|cop }}
                  {% endif %}
                </td>
                <td>
                  <div class="fw-semibold">{{ mov.user.get_full_name|default:mov.user.username }}</div>
                  <small class="text-muted">{{ mov.user.username }}</small>
                </td>
                <td>
                  <div>{{ mov.created_at|date:"Y-m-d" }}</div>
                  <small class="text-muted">{{ mov.created_at|date:"H:i" }}</small>
                </td>
                <td>
                  <div class="d-flex justify-content-center">
                    {% if perms.products.change_inventorymovement %}
                      <a href="{% url 'backoffice:products:inventory:inventory_update' mov.id %}"
                         class="btn btn-sm btn-outline-secondary me-1"
                         data-bs-toggle="tooltip" title="Editar movimiento">
                        <i class="bi bi-pencil"></i>
                      </a>
                    {% endif %}
                    {% if perms.products.delete_inventorymovement %}
                      <a href="{% url 'backoffice:products:inventory:inventory_delete' mov.id %}"
                         class="btn btn-sm btn-outline-danger"
                         data-bs-toggle="tooltip" title="Eliminar movimiento">
                        <i class="bi bi-trash"></i>
                      </a>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="10" class="text-center text-muted py-4">
                  <i class="bi bi-inbox fs-1 d-block mb-2 opacity-50"></i>
                  No hay movimientos registrados con los filtros aplicados.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>


  <!-- Paginación -->
  {% if is_paginated %}
  <nav class="mt-4" aria-label="Navegación de movimientos">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page=1&{{ querystring }}">
            <i class="bi bi-chevron-double-left"></i>
          </a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}&{{ querystring }}">
            <i class="bi bi-chevron-left"></i> Anterior
          </a>
        </li>
      {% endif %}

      <li class="page-item active">
        <span class="page-link">
          Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        </span>
      </li>

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}&{{ querystring }}">
            Siguiente <i class="bi bi-chevron-right"></i>
          </a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&{{ querystring }}">
            <i class="bi bi-chevron-double-right"></i>
          </a>
        </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>
{% endblock %}
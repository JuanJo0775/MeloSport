{% extends "backoffice/base_backoffice.html" %}
{% load breadcrumbs %}
{% load static %}

{% block title %}Ajuste de Inventario{% endblock %}

{% block breadcrumb %}
  {% breadcrumb "Inventario|backoffice:products:inventory:index" "Productos|backoffice:products:inventory:products_inventory_list" "Ajuste stock" %}
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Encabezado -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-2">Nuevo Ajuste de Inventario</h1>
          <p class="text-muted mb-0">
            Registra un ajuste para corregir el stock de productos (añadir o quitar).
          </p>
        </div>
        <div class="ms-auto">
          <a href="{% url 'backoffice:products:inventory:products_inventory_list' %}"
             class="btn btn-outline-secondary"
             data-bs-toggle="tooltip"
             title="Volver a la lista">
            <i class="bi bi-arrow-left me-1"></i>Volver
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulario Principal -->
  <div class="row justify-content-center">
    <div class="col-xl-8 col-lg-10">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom">
          <h5 class="card-title mb-0 d-flex align-items-center">
            <i class="bi bi-sliders text-warning me-2"></i>
            Datos del Ajuste
          </h5>
        </div>
        <div class="card-body p-4">

          <!-- Mostrar errores -->
          {% if form.errors %}
          <div class="alert alert-danger border-0 mb-4">
            <div class="d-flex">
              <div class="flex-shrink-0">
                <i class="bi bi-exclamation-triangle fs-4"></i>
              </div>
              <div class="flex-grow-1 ms-3">
                <h6 class="alert-heading mb-2">Errores en el formulario</h6>
                <ul class="mb-0">
                  {% for field, errors in form.errors.items %}
                    <li><strong>{{ field|capfirst }}:</strong> {{ errors|join:", " }}</li>
                  {% endfor %}
                  {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- Bloque informativo -->
          <div class="alert alert-info d-flex align-items-start mb-4">
            <i class="bi bi-info-circle me-2 fs-5 text-primary"></i>
            <div>
              <strong>Nota:</strong> Selecciona si deseas añadir o quitar stock.
              Ingresa una cantidad positiva (nunca negativa).
              Si eliges quitar, no podrás exceder el stock disponible.
              El motivo es obligatorio y se guardará en auditoría.
            </div>
          </div>

          <!-- Formulario -->
          <form method="post" id="adjust-form">
            {% csrf_token %}
            <div class="row g-3">

              <!-- Producto -->
              <div class="col-md-6">
                <label class="form-label fw-semibold">
                  {% if form.product_display %}
                    {{ form.product_display.label }}
                  {% else %}
                    {{ form.product.label }}
                  {% endif %}
                </label>
                {% if form.product_display %}
                  {{ form.product_display }}
                  {{ form.product }} {# hidden con valor real #}
                {% else %}
                  {{ form.product }}
                {% endif %}
              </div>

              <!-- Variante -->
              <div class="col-md-6" id="variant-container">
                {% if form.variant %}
                  <label class="form-label fw-semibold">{{ form.variant.label }}</label>
                  {{ form.variant }}
                {% endif %}
              </div>

              <!-- Acción (añadir/quitar) -->
              <div class="col-md-12">
                <label class="form-label fw-semibold d-block">{{ form.action.label }}</label>
                <div class="d-flex gap-3">

                  <!-- Botón Añadir -->
                  <div>
                    <input type="radio"
                           class="btn-check"
                           name="action"
                           id="action_add"
                           value="add"
                           {% if form.action.value == "add" %}checked{% endif %}>
                    <label class="btn btn-outline-success fw-semibold px-4 py-2" for="action_add">
                      <i class="bi bi-plus-circle me-1"></i> Añadir stock
                    </label>
                  </div>

                  <!-- Botón Quitar -->
                  <div>
                    <input type="radio"
                           class="btn-check"
                           name="action"
                           id="action_remove"
                           value="remove"
                           {% if form.action.value == "remove" %}checked{% endif %}>
                    <label class="btn btn-outline-danger fw-semibold px-4 py-2" for="action_remove">
                      <i class="bi bi-dash-circle me-1"></i> Quitar stock
                    </label>
                  </div>

                </div>
                {% if form.action.help_text %}
                  <div class="form-text mt-1">{{ form.action.help_text }}</div>
                {% endif %}
              </div>

              <!-- Cantidad -->
              <div class="col-md-4">
                <label class="form-label fw-semibold">{{ form.quantity.label }}</label>
                {{ form.quantity }}
                {% if form.quantity.help_text %}
                  <div class="form-text">{{ form.quantity.help_text }}</div>
                {% endif %}
              </div>

              <!-- Motivo -->
              <div class="col-md-8">
                <label class="form-label fw-semibold">{{ form.adjust_reason.label }}</label>
                {{ form.adjust_reason }}
                {% if form.adjust_reason.help_text %}
                  <div class="form-text">{{ form.adjust_reason.help_text }}</div>
                {% endif %}
              </div>

              <!-- Notas -->
              <div class="col-md-12">
                <label class="form-label fw-semibold">{{ form.notes.label }}</label>
                {{ form.notes }}
                {% if form.notes.help_text %}
                  <div class="form-text">{{ form.notes.help_text }}</div>
                {% else %}
                  <div class="form-text">Observaciones adicionales (opcional)</div>
                {% endif %}
              </div>

            </div>

            <!-- Botones -->
            <div class="row mt-4">
              <div class="col-12">
                <div class="d-flex gap-2 justify-content-end">
                  <a href="{% url 'backoffice:products:inventory:products_inventory_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-lg me-2"></i>Cancelar
                  </a>
                  <button type="submit" class="btn btn-warning">
                    <i class="bi bi-check-lg me-2"></i>Guardar Ajuste
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JS para recargar variantes según producto -->
<script>
(function(){
  const productSelect = document.querySelector("select[name='product']");
  const variantContainer = document.getElementById("variant-container");

  function renderVariantSelect(variants){
    if(!variants.length){
      variantContainer.innerHTML = "";
      return;
    }
    let html = "<label class='form-label fw-semibold'>Variante</label>";
    html += "<select name='variant' id='id_variant' class='form-select'>";
    html += "<option value=''>-- Seleccionar variante --</option>";
    variants.forEach(v => {
      html += `<option value='${v.id}'>${v.label} — stock: ${v.stock}</option>`;
    });
    html += "</select>";
    html += "<div class='form-text'>Selecciona la variante específica del producto</div>";
    variantContainer.innerHTML = html;
  }

  function loadVariants(productId){
    if(!productId){
      renderVariantSelect([]);
      return;
    }
    const url = "{% url 'backoffice:products:inventory:product_variants_json' 0 %}"
                  .replace("/0/", "/" + productId + "/");
    fetch(url)
      .then(r => r.json())
      .then(data => renderVariantSelect(data.variants || []))
      .catch(console.error);
  }

  if(productSelect){
    if(productSelect.value){
      loadVariants(productSelect.value);
    }
    productSelect.addEventListener("change", e => loadVariants(e.target.value));
  }
})();
</script>
{% endblock %}

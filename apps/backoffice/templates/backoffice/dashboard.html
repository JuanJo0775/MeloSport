{% extends "backoffice/base_backoffice.html" %}

{% block title %}Dashboard - Panel Administrativo - Melosport{% endblock %}
{% load friendly_datetime %}
{% load money %}
{% load breadcrumbs %}

{% block breadcrumb %}
  {% breadcrumb "Dashboard" %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Bienvenida y resumen r√°pido -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card shadow-sm border-0 rounded-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h2 class="card-title h4 mb-1">
                  ¬°Bienvenido de vuelta {{ request.user.first_name|default:request.user.username }}!
                </h2>
                <p class="text-muted mb-0">
                  {% if last_login %}
                    Tu √∫ltimo inicio de sesi√≥n fue
                    <strong>{{ last_login|friendly_datetime }}</strong>.
                  {% else %}
                    <strong>Esta es tu primera vez en el sistema üéâ</strong>
                  {% endif %}
                </p>
              </div>
              <div class="text-end">
                <small class="text-muted">Sesi√≥n actual:</small>
                <strong class="text-primary">
                  {{ current_login|friendly_datetime }}
                </strong>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alerta de Stock Bajo -->
    {% if stats.low_stock > 0 or stats.no_stock > 0 %}
      <div class="alert alert-danger d-flex align-items-center shadow-sm mb-4" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2 fs-4"></i>
        <div>
          üö® Atenci√≥n:
          {% if stats.low_stock > 0 %}
            <strong>{{ stats.low_stock }}</strong> con stock bajo
          {% endif %}
          {% if stats.no_stock > 0 %}
            {% if stats.low_stock > 0 %} y {% endif %}
            <strong>{{ stats.no_stock }}</strong> sin stock
          {% endif %}.
          <a href="{% url 'backoffice:products:inventory:products_inventory_list' %}?filter=low_stock" class="alert-link ms-2">
            Ver inventario
          </a>
        </div>
      </div>
    {% endif %}

   <!-- Tarjetas de estad√≠sticas principales -->
    <div class="row mb-4">
        <!-- Total Productos -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stats-card border-left-primary h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Total Productos
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ stats.products_count }}
                        </div>
                    </div>
                    <i class="bi bi-box stats-icon"></i>
                </div>
            </div>
        </div>

        <!-- Valor Inventario -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stats-card border-left-success h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Valor Inventario
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ stats.inventory_value|cop }}
                        </div>
                    </div>
                    <i class="bi bi-currency-dollar stats-icon text-success"></i>
                </div>
            </div>
        </div>

        <!-- Stock Cr√≠tico -->
        <div class="col-xl-3 col-md-6 mb-4">
          <div class="card stats-card h-100"
               style="border-left: 6px solid {% if stats.low_stock|add:stats.no_stock > 0 %}red{% else %}green{% endif %}; background-color: white;">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <div class="text-xs font-weight-bold text-uppercase mb-1"
                     style="color: {% if stats.low_stock|add:stats.no_stock > 0 %}red{% else %}green{% endif %};">
                  Stock Cr√≠tico
                </div>
                <div class="h5 mb-0 font-weight-bold"
                     style="color: {% if stats.low_stock|add:stats.no_stock > 0 %}red{% else %}green{% endif %};">
                  {{ stats.low_stock|add:stats.no_stock }}
                </div>
              </div>
              <i class="bi {% if stats.low_stock|add:stats.no_stock > 0 %}bi-exclamation-triangle-fill{% else %}bi-check-circle-fill{% endif %}"
                 style="font-size: 2rem; color: {% if stats.low_stock|add:stats.no_stock > 0 %}red{% else %}green{% endif %};"></i>
            </div>
          </div>
        </div>

        <!-- Categor√≠as -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stats-card border-left-info h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            Categor√≠as
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ stats.categories_count }}
                        </div>
                    </div>
                    <i class="bi bi-tags stats-icon text-info"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°ficos y reportes -->
    <div class="row mb-4">
        <!-- Gr√°fico de movimientos -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Movimientos de Inventario - √öltimos 7 d√≠as</h6>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#">Ver reporte completo</a></li>
                            <li><a class="dropdown-item" href="#">Exportar datos</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body" style="min-height: 320px;">
                    <!-- canvas con alto controlado para evitar estiramiento infinito -->
                    <canvas id="movimientosChart" style="width:100%; height:300px; max-height:300px;"></canvas>
                </div>
            </div>
        </div>

        <!-- Top productos -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Productos M√°s Vendidos</h6>
                </div>
                <div class="card-body" style="max-height: 330px; overflow-y: auto;">
                    {% if top_products %}
                      {% for p in top_products %}
                        <div class="mb-3 pb-3 border-bottom d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-bold">{{ p.name }}</div>
                                <small class="text-muted">SKU: {{ p.sku }}</small>
                            </div>
                            <span class="badge bg-success">{{ p.qty }} vendidos</span>
                        </div>
                      {% endfor %}
                    {% else %}
                      <div class="text-center text-muted py-4">
                          <i class="bi bi-bar-chart display-6 d-block mb-2 text-primary"></i>
                          <p class="mb-0 fw-semibold">No hay ventas recientes</p>
                      </div>
                    {% endif %}
                    <div class="text-center mt-2">
                        <a href="#" class="btn btn-sm btn-outline-primary">Ver todos los reportes <i class="bi bi-arrow-right"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas y Notificaciones -->
    <div class="row mb-4">
      <!-- Alertas de Stock -->
      <div class="col-lg-6 mb-4">
        <div class="card h-100 d-flex flex-column">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-danger">Alertas de Stock</h6>
            <span class="badge bg-danger">
              {{ stats.low_stock|add:stats.no_stock }}
            </span>
          </div>
          <div class="card-body flex-grow-1 d-flex flex-column p-0">
            <div class="p-3" style="flex:1; overflow-y:auto; max-height:260px;">
              {% for product in stock_alerts %}
                <div class="alert {% if product.stock == 0 %}alert-danger border-start border-danger{% else %}alert-warning border-start border-warning{% endif %} py-2 px-3 mb-2" role="alert">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 me-2">
                      {% if product.stock == 0 %}
                        <i class="bi bi-x-circle-fill"></i>
                      {% else %}
                        <i class="bi bi-exclamation-triangle-fill"></i>
                      {% endif %}
                    </div>
                    <div class="flex-grow-1">
                      <strong>{{ product.name }}</strong><br>
                      <small class="text-muted">SKU: {{ product.sku }} ‚Ä¢ Stock: {{ product.stock }} unidades</small>
                    </div>
                  </div>
                </div>
            {% empty %}
              <div class="text-center text-muted py-4">
                <i class="bi bi-check-circle display-5 d-block mb-2 text-success"></i>
                <p class="mb-0 fw-semibold">No hay alertas de stock</p>
              </div>
            {% endfor %}
            </div>
            <div class="card-footer bg-white border-top text-center">
              <a href="{% url 'backoffice:products:inventory:products_inventory_list' %}?filter=low_stock"
                 class="btn btn-sm btn-outline-danger w-100">
                Ver todas las alertas
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Actividad Reciente -->
      <div class="col-lg-6 mb-4">
        <div class="card h-100 d-flex flex-column">
          <div class="card-header">
            <h6 class="m-0 font-weight-bold text-primary">Actividad Reciente</h6>
          </div>
          <div class="card-body flex-grow-1 d-flex flex-column p-0">
            <div class="p-3" style="flex:1; overflow-y:auto; max-height:260px;">
              {% if recent_activity %}
                <ul class="list-unstyled mb-0">
                  {% for log in recent_activity %}
                    <li class="d-flex align-items-start mb-3 pb-2 border-bottom">
                      <div class="flex-shrink-0">
                        {% if log.action == "create" %}
                          <span class="d-flex align-items-center justify-content-center bg-primary text-white rounded-circle" style="width:32px;height:32px;">
                            <i class="bi bi-plus"></i>
                          </span>
                        {% elif log.action == "update" %}
                          <span class="d-flex align-items-center justify-content-center bg-success text-white rounded-circle" style="width:32px;height:32px;">
                            <i class="bi bi-pencil"></i>
                          </span>
                        {% elif log.action == "delete" %}
                          <span class="d-flex align-items-center justify-content-center bg-danger text-white rounded-circle" style="width:32px;height:32px;">
                            <i class="bi bi-trash"></i>
                          </span>
                        {% elif log.action == "login" %}
                          <span class="d-flex align-items-center justify-content-center bg-info text-white rounded-circle" style="width:32px;height:32px;">
                            <i class="bi bi-person-check"></i>
                          </span>
                        {% elif log.action == "logout" %}
                          <span class="d-flex align-items-center justify-content-center bg-warning text-white rounded-circle" style="width:32px;height:32px;">
                            <i class="bi bi-box-arrow-right"></i>
                          </span>
                        {% else %}
                          <span class="d-flex align-items-center justify-content-center bg-secondary text-white rounded-circle" style="width:32px;height:32px;">
                            <i class="bi bi-activity"></i>
                          </span>
                        {% endif %}
                      </div>
                      <div class="flex-grow-1 ms-3">
                        <div class="fw-semibold">{{ log.get_action_display }}</div>
                        <small class="text-muted">
                          {{ log.user.username }} ‚Ä¢ {{ log.created_at|timesince }} atr√°s
                        </small>
                        {% if log.description %}
                          <div class="small text-muted">{{ log.description }}</div>
                        {% endif %}
                      </div>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <div class="text-center text-muted py-4">
                  <i class="bi bi-inbox display-6 d-block mb-2"></i>
                  No hay actividad reciente
                </div>
              {% endif %}
            </div>
            {% if request.user.is_superuser %}
              <div class="card-footer bg-white border-top text-center">
                <a href="{% url 'backoffice:users:auditlog_list' %}" class="btn btn-sm btn-outline-primary w-100">
                  Ver historial completo
                </a>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Acciones r√°pidas -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Acciones R√°pidas</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 col-sm-6 mb-3">
                            <a href="{% url 'backoffice:products:product_create' %}" class="btn btn-outline-primary w-100 p-3">
                                <i class="bi bi-box-seam d-block mb-2" style="font-size: 2rem;"></i>
                                Agregar Producto
                            </a>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <a href="{% url 'backoffice:products:inventory:products_inventory_list' %}"
                               class="btn w-100 p-3"
                               style="color:#fd7e14; border:1px solid #fd7e14; background-color:transparent;"
                               onmouseover="this.style.backgroundColor='#fd7e14'; this.style.color='#fff';"
                               onmouseout="this.style.backgroundColor='transparent'; this.style.color='#fd7e14';">
                                <i class="bi bi-boxes d-block mb-2" style="font-size: 2rem;"></i>
                                Agregar stock
                            </a>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <a href="{% url 'backoffice:billing:sale_create' %}" class="btn btn-outline-success w-100 p-3">
                                <i class="bi bi-cash-coin d-block mb-2" style="font-size: 2rem;"></i>
                                Nueva venta
                            </a>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <!-- Bot√≥n Nueva reserva: color actualizado inline -->
                            <a href="{% url 'backoffice:billing:reservation_create' %}" class="btn w-100 p-3"
                               style="color:#6f42c1; border:1px solid #6f42c1; background-color:transparent;"
                               onmouseover="this.style.backgroundColor='#6f42c1'; this.style.color='#fff';"
                               onmouseout="this.style.backgroundColor='transparent'; this.style.color='#6f42c1';">
                                <i class="bi bi-card-list d-block mb-2" style="font-size: 2rem;"></i>
                                Nueva reserva
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js CDN (si ya est√° cargado en base no hace da√±o) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Datos provenientes del backend (fallo seguro a arrays vac√≠os si no hay datos)
  const labelsRaw = {{ chart_labels_json|default:"[]"|safe }};
  const entriesRaw = {{ chart_entries_json|default:"[]"|safe }};
  const exitsRaw = {{ chart_exits_json|default:"[]"|safe }};

  // Si el backend no devolvi√≥ labels (vac√≠o), generamos los √∫ltimos 7 d√≠as (nombres cortos en espa√±ol)
  function lastNDaysLabels(n) {
    const arr = [];
    const today = new Date();
    for (let i = n-1; i >= 0; i--) {
      const d = new Date();
      d.setDate(today.getDate() - i);
      // 'es-CO' para espa√±ol. Resultado: "lun.", "mar.", ...
      try {
        arr.push(d.toLocaleDateString('es-CO', { weekday: 'short' }));
      } catch(e) {
        arr.push(d.toISOString().slice(0,10));
      }
    }
    return arr;
  }

  // Formatea fechas tipo "YYYY-MM-DD" a d√≠a corto en espa√±ol si es posible
  function formatLabels(raw) {
    if (!Array.isArray(raw) || raw.length === 0) return lastNDaysLabels(7);
    try {
      return raw.map(s => {
        // Asegurar formato ISO para Date
        const d = new Date(s + 'T00:00:00');
        return d.toLocaleDateString('es-CO', { weekday: 'short' });
      });
    } catch (e) {
      return raw;
    }
  }

  const labels = formatLabels(labelsRaw);
  const entries = (Array.isArray(entriesRaw) && entriesRaw.length) ? entriesRaw : new Array(labels.length).fill(0);
  const exits = (Array.isArray(exitsRaw) && exitsRaw.length) ? exitsRaw : new Array(labels.length).fill(0);

  // Debug console (borra si quieres)
  console.log("Dashboard labels:", labelsRaw, " -> shown:", labels);
  console.log("Entries:", entries);
  console.log("Exits:", exits);

  // Evitar crear m√∫ltiples instancias si la p√°gina re-renderiza el script
  if (window.movimientosChartInstance) {
    try { window.movimientosChartInstance.destroy(); } catch(e){/*ignore*/ }
    window.movimientosChartInstance = null;
  }

  const ctx = document.getElementById('movimientosChart').getContext('2d');

  // Crear gr√°fico
  window.movimientosChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Entradas',
          data: entries,
          borderColor: '#0d6efd',
          backgroundColor: 'rgba(13,110,253,0.08)',
          fill: true,
          tension: 0.25,
          pointRadius: 3,
          pointHoverRadius: 5
        },
        {
          label: 'Salidas',
          data: exits,
          borderColor: '#fd7e14',
          backgroundColor: 'rgba(253,126,20,0.08)',
          fill: true,
          tension: 0.25,
          pointRadius: 3,
          pointHoverRadius: 5
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false, // importante para que respete el alto del canvas
      animation: { duration: 600, easing: 'easeOutQuart' },
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top' },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        x: {
          grid: { display: false },
        },
        y: {
          beginAtZero: true,
          ticks: { precision: 0 }
        }
      }
    }
  });

});
</script>
{% endblock %}

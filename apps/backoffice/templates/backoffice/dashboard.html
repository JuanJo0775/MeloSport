{% extends "backoffice/base_backoffice.html" %}

{% block title %}Dashboard - Panel Administrativo - Melosport{% endblock %}
{% load friendly_datetime %}
{% load money %}

{% load breadcrumbs %}
{% block breadcrumb %}
  {% breadcrumb "Dashboard" %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Bienvenida y resumen r√°pido -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card shadow-sm border-0 rounded-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h2 class="card-title h4 mb-1">
                  ¬°Bienvenido de vuelta {{ request.user.first_name|default:request.user.username }}!
                </h2>
                <p class="text-muted mb-0">
                  {% if last_login %}
                    Tu √∫ltimo inicio de sesi√≥n fue
                    <strong>{{ last_login|friendly_datetime }}</strong>.
                  {% else %}
                    <strong>Esta es tu primera vez en el sistema üéâ</strong>
                  {% endif %}
                </p>
              </div>
              <div class="text-end">
                <small class="text-muted">Sesi√≥n actual:</small>
                <strong class="text-primary">
                  {{ current_login|friendly_datetime }}
                </strong>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alerta de Stock Bajo -->
    {% if stats.low_stock > 0 or stats.no_stock > 0 %}
      <div class="alert alert-danger d-flex align-items-center shadow-sm mb-4" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2 fs-4"></i>
        <div>
          üö® Atenci√≥n:
          {% if stats.low_stock > 0 %}
            <strong>{{ stats.low_stock }}</strong> con stock bajo
          {% endif %}
          {% if stats.no_stock > 0 %}
            {% if stats.low_stock > 0 %} y {% endif %}
            <strong>{{ stats.no_stock }}</strong> sin stock
          {% endif %}.
          <a href="{% url 'backoffice:products:inventory:products_inventory_list' %}?filter=low_stock" class="alert-link ms-2">
            Ver inventario
          </a>
        </div>
      </div>
    {% endif %}



   <!-- Tarjetas de estad√≠sticas principales -->
    <div class="row mb-4">
        <!-- Total Productos -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stats-card border-left-primary h-100">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Productos
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ stats.products_count }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-box stats-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Valor Inventario -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stats-card border-left-success h-100">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Valor Inventario
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ stats.inventory_value|cop }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-currency-dollar stats-icon text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Stock Cr√≠tico -->
        <div class="col-xl-3 col-md-6 mb-4">
          <div class="card stats-card h-100"
               style="border-left: 6px solid {% if stats.low_stock|add:stats.no_stock > 0 %}red{% else %}green{% endif %}; background-color: white;">
            <div class="card-body">
              <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                  <div class="text-xs font-weight-bold text-uppercase mb-1"
                       style="color: {% if stats.low_stock|add:stats.no_stock > 0 %}red{% else %}green{% endif %};">
                    Stock Cr√≠tico
                  </div>
                  <div class="h5 mb-0 font-weight-bold"
                       style="color: {% if stats.low_stock|add:stats.no_stock > 0 %}red{% else %}green{% endif %};">
                    {{ stats.low_stock|add:stats.no_stock }}
                  </div>
                </div>
                <div class="col-auto">
                  <i class="bi {% if stats.low_stock|add:stats.no_stock > 0 %}bi-exclamation-triangle-fill{% else %}bi-check-circle-fill{% endif %}"
                     style="font-size: 2rem; color: {% if stats.low_stock|add:stats.no_stock > 0 %}red{% else %}green{% endif %};"></i>
                </div>
              </div>
            </div>
          </div>
        </div>



        <!-- Categor√≠as -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stats-card border-left-info h-100">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Categor√≠as
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ stats.categories_count }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-tags stats-icon text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°ficos y reportes -->
    <div class="row mb-4">
        <!-- Gr√°fico de ventas -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Movimientos de Inventario - √öltimos 7 d√≠as</h6>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#">Ver reporte completo</a></li>
                            <li><a class="dropdown-item" href="#">Exportar datos</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="movimientosChart" class="chart-canvas"></canvas>
                </div>
            </div>
        </div>

        <!-- Top productos -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Productos M√°s Vendidos</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3 pb-3 border-bottom">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-bold">Bal√≥n F√∫tbol Profesional</div>
                                <small class="text-muted">SKU: BFP-001</small>
                            </div>
                            <span class="badge bg-success">45 vendidos</span>
                        </div>
                    </div>

                    <div class="mb-3 pb-3 border-bottom">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-bold">Camiseta Deportiva L</div>
                                <small class="text-muted">SKU: CD-L-002</small>
                            </div>
                            <span class="badge bg-success">38 vendidos</span>
                        </div>
                    </div>

                    <div class="mb-3 pb-3 border-bottom">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-bold">Zapatillas Running</div>
                                <small class="text-muted">SKU: ZR-42-003</small>
                            </div>
                            <span class="badge bg-success">32 vendidos</span>
                        </div>
                    </div>

                    <div class="text-center">
                        <a href="#" class="btn btn-sm btn-outline-primary">Ver todos los reportes <i class="bi bi-arrow-right"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas y Notificaciones -->
    <div class="row mb-4">
      <!-- Alertas de Stock -->
      <div class="col-lg-6 mb-4">
        <div class="card h-100 d-flex flex-column">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-danger">Alertas de Stock</h6>
            <span class="badge bg-danger">
              {{ stats.low_stock|add:stats.no_stock }}
            </span>
          </div>
          <div class="card-body flex-grow-1 d-flex flex-column p-0">
            <div class="p-3" style="flex:1; overflow-y:auto; max-height:260px;">
              {% for product in stock_alerts %}
                <div class="alert {% if product.stock == 0 %}alert-danger border-start border-danger{% else %}alert-warning border-start border-warning{% endif %} py-2 px-3 mb-2" role="alert">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 me-2">
                      {% if product.stock == 0 %}
                        <i class="bi bi-x-circle-fill"></i>
                      {% else %}
                        <i class="bi bi-exclamation-triangle-fill"></i>
                      {% endif %}
                    </div>
                    <div class="flex-grow-1">
                      <strong>{{ product.name }}</strong><br>
                      <small class="text-muted">SKU: {{ product.sku }} ‚Ä¢ Stock: {{ product.stock }} unidades</small>
                    </div>
                  </div>
                </div>
            {% empty %}
              <div class="text-center text-muted py-4">
                <i class="bi bi-check-circle display-5 d-block mb-2 text-success"></i>
                <p class="mb-0 fw-semibold">No hay alertas de stock</p>
              </div>
            {% endfor %}
            </div>
            <div class="card-footer bg-white border-top text-center">
              <a href="{% url 'backoffice:products:inventory:products_inventory_list' %}?filter=low_stock"
                 class="btn btn-sm btn-outline-danger w-100">
                Ver todas las alertas
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Actividad Reciente -->
      <div class="col-lg-6 mb-4">
        <div class="card h-100 d-flex flex-column">
          <div class="card-header">
            <h6 class="m-0 font-weight-bold text-primary">Actividad Reciente</h6>
          </div>
          <div class="card-body flex-grow-1 d-flex flex-column p-0">
            <div class="p-3" style="flex:1; overflow-y:auto; max-height:260px;">
              {% if recent_activity %}
                <ul class="list-unstyled mb-0">
                  {% for log in recent_activity %}
                    <li class="d-flex align-items-start mb-3 pb-2 border-bottom">
                      <div class="flex-shrink-0">
                        {% if log.action == "create" %}
                          <span class="d-flex align-items-center justify-content-center bg-primary text-white rounded-circle" style="width:32px;height:32px;">
                            <i class="bi bi-plus"></i>
                          </span>
                        {% elif log.action == "update" %}
                          <span class="d-flex align-items-center justify-content-center bg-success text-white rounded-circle" style="width:32px;height:32px;">
                            <i class="bi bi-pencil"></i>
                          </span>
                        {% elif log.action == "delete" %}
                          <span class="d-flex align-items-center justify-content-center bg-danger text-white rounded-circle" style="width:32px;height:32px;">
                            <i class="bi bi-trash"></i>
                          </span>
                        {% elif log.action == "login" %}
                          <span class="d-flex align-items-center justify-content-center bg-info text-white rounded-circle" style="width:32px;height:32px;">
                            <i class="bi bi-person-check"></i>
                          </span>
                        {% elif log.action == "logout" %}
                          <span class="d-flex align-items-center justify-content-center bg-warning text-white rounded-circle" style="width:32px;height:32px;">
                            <i class="bi bi-box-arrow-right"></i>
                          </span>
                        {% else %}
                          <span class="d-flex align-items-center justify-content-center bg-secondary text-white rounded-circle" style="width:32px;height:32px;">
                            <i class="bi bi-activity"></i>
                          </span>
                        {% endif %}
                      </div>
                      <div class="flex-grow-1 ms-3">
                        <div class="fw-semibold">{{ log.get_action_display }}</div>
                        <small class="text-muted">
                          {{ log.user.username }} ‚Ä¢ {{ log.created_at|timesince }} atr√°s
                        </small>
                        {% if log.description %}
                          <div class="small text-muted">{{ log.description }}</div>
                        {% endif %}
                      </div>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <div class="text-center text-muted py-4">
                  <i class="bi bi-inbox display-6 d-block mb-2"></i>
                  No hay actividad reciente
                </div>
              {% endif %}
            </div>
            {% if request.user.is_superuser %}
              <div class="card-footer bg-white border-top text-center">
                <a href="{% url 'backoffice:users:auditlog_list' %}" class="btn btn-sm btn-outline-primary w-100">
                  Ver historial completo
                </a>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>


        <!-- Acciones r√°pidas -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Acciones R√°pidas</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 col-sm-6 mb-3">
                                <a href="{% url 'backoffice:products:product_create' %}" class="btn btn-outline-primary w-100 p-3">
                                    <i class="bi bi-box-seam d-block mb-2" style="font-size: 2rem;"></i>
                                    Agregar Producto
                                </a>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <a href="{% url 'backoffice:products:inventory:products_inventory_list' %}"
                                   class="btn w-100 p-3"
                                   style="color:#fd7e14; border:1px solid #fd7e14; background-color:transparent;"
                                   onmouseover="this.style.backgroundColor='#fd7e14'; this.style.color='#fff';"
                                   onmouseout="this.style.backgroundColor='transparent'; this.style.color='#fd7e14';">
                                    <i class="bi bi-boxes d-block mb-2" style="font-size: 2rem;"></i>
                                    Agregar stock
                                </a>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <a href="{% url 'backoffice:billing:sale_create' %}" class="btn btn-outline-success w-100 p-3">
                                    <i class="bi bi-cash-coin d-block mb-2" style="font-size: 2rem;"></i>
                                    Nueva venta
                                </a>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <a href="{% url 'backoffice:backup-create' %}" class="btn btn-outline-warning w-100 p-3">
                                    <i class="bi bi-database d-block mb-2" style="font-size: 2rem;"></i>
                                    Crear Respaldo
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Configuraci√≥n del gr√°fico de movimientos
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('movimientosChart').getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'],
                datasets: [{
                    label: 'Entradas',
                    data: [12, 19, 8, 5, 2, 3, 15],
                    borderColor: 'rgb(13, 110, 253)',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    tension: 0.1
                }, {
                    label: 'Salidas',
                    data: [7, 11, 5, 8, 3, 7, 12],
                    borderColor: 'rgb(253, 126, 20)',
                    backgroundColor: 'rgba(253, 126, 20, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Actualizar autom√°ticamente las estad√≠sticas cada 5 minutos
        setInterval(function() {
            // Aqu√≠ se implementar√≠a la l√≥gica para actualizar datos en tiempo real
            console.log('Actualizando estad√≠sticas...');
        }, 300000); // 5 minutos
    });
</script>
{% endblock %}